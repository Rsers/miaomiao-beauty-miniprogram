# 功能快速索引

> **快速查找**：本文档提供所有功能的快速索引，详细内容请参考 `功能实现记录与恢复指南.md`

---

## 📋 前端页面索引

| 页面名称 | 位置 | Git提交 | 恢复命令 | 说明 |
|---------|------|---------|---------|------|
| 首页 | `.trash/pages/home/` | `e2bc7ed` | `cp -r .trash/pages/home/ miniprogram/pages/` | 功能导航首页 |
| 美颜相机 | `.trash/pages/camera/` | `d0f9975` | `cp -r .trash/pages/camera/ miniprogram/pages/` | AI换脸、滤镜 |
| 拼图协作 | `.trash/pages/puzzle/` | `bc7af54` | `cp -r .trash/pages/puzzle/ miniprogram/pages/` | 多人拼图游戏 |
| 推荐奖励 | `.trash/pages/referral/` | `130bb7c` | `cp -r .trash/pages/referral/ miniprogram/pages/` | 邀请码、奖励 |
| 邀请好友 | `.trash/pages/invite/` | `a7226a5` | `cp -r .trash/pages/invite/ miniprogram/pages/` | 好友列表 |
| 积分商城 | `.trash/pages/mall/` | `5d02a95` | `cp -r .trash/pages/mall/ miniprogram/pages/` | 积分兑换 |
| 个人资料 | `.trash/pages/profile/` | `ad39b35` | `cp -r .trash/pages/profile/ miniprogram/pages/` | 用户中心 |
| 用户流程 | `.trash/pages/userflow/` | `ad39b35` | `cp -r .trash/pages/userflow/ miniprogram/pages/` | 流程演示 |
| 日志页面 | `.trash/pages/logs/` | - | `cp -r .trash/pages/logs/ miniprogram/pages/` | 示例页面 |

---

## 🔧 后端功能索引

| 功能名称 | Git分支 | Git提交 | 涉及文件 | API端点 |
|---------|---------|---------|---------|---------|
| **微信支付** | `main` | `7f49a09` | `index.ts/wxml/wxss` | `/api/wechat/pay/create` |
| **OpenID获取** | `main` | `1b85768` | `index.ts` | `/api/wechat/auth/openid` |
| **用户头像昵称** | `main` | `eb0cf7a` | `index.ts/wxml/wxss` | 无需后端 |
| **用户等级系统** | `feature/frontend-optimization` | - | `index.ts` | 本地存储 |
| **剩余次数管理** | `feature/frontend-optimization` | - | `index.ts` | 本地存储 |

---

## 🎯 快速恢复命令

### 恢复所有页面
```bash
# 一键恢复所有删除的页面
for dir in .trash/pages/*/; do
  dirname=$(basename "$dir")
  cp -r "$dir" "miniprogram/pages/$dirname"
done

# 然后在app.json中添加页面路径
```

### 恢复微信支付功能
```bash
# 1. 查看main分支的支付代码
git show main:miniprogram/pages/index/index.ts | grep -A 80 "createPayment" > /tmp/payment_code.ts

# 2. 手动复制到当前index.ts
# 需要复制的方法：
# - selectPackage()
# - createPayment()
# - callWeChatPay()
# - updateUserPackage()
```

### 恢复用户系统
```bash
# 查看main分支的用户系统代码
git show main:miniprogram/pages/index/index.ts | grep -A 50 "loadUserInfo" > /tmp/user_system.ts

# 需要复制的方法：
# - loadUserInfo()
# - onChooseAvatar()
# - onNicknameInput()
# - loadUserStatus()
# - checkUserRemainingCount()
```

---

## 📊 代码位置快速查找

### 关键方法位置

| 方法名 | 功能 | 所在分支 | 文件 |
|-------|------|---------|------|
| `getUserOpenId()` | 获取OpenID | `main` | `pages/index/index.ts` |
| `selectPackage()` | 选择套餐 | `main` | `pages/index/index.ts` |
| `createPayment()` | 创建支付 | `main` | `pages/index/index.ts` |
| `callWeChatPay()` | 调用支付 | `main` | `pages/index/index.ts` |
| `onChooseAvatar()` | 选择头像 | `main` | `pages/index/index.ts` |
| `onNicknameInput()` | 输入昵称 | `main` | `pages/index/index.ts` |
| `checkUserRemainingCount()` | 检查次数 | `feature/frontend-optimization` | `pages/index/index.ts` |
| `updateUserPackage()` | 更新套餐 | `main` | `pages/index/index.ts` |

### UI组件位置

| 组件名 | 功能 | 所在分支 | 文件 |
|-------|------|---------|------|
| 用户头像区域 | 头像选择 | `main` | `pages/index/index.wxml` (行3-9) |
| 昵称输入区域 | 昵称输入 | `main` | `pages/index/index.wxml` (行11-17) |
| 付费套餐区域 | 套餐选择 | `main` | `pages/index/index.wxml` (行19-97) |
| 用户状态显示 | 次数/等级 | `feature/frontend-optimization` | `pages/index/index.wxml` (行74-84) |

---

## 🔍 Git命令快查

### 查看特定文件的历史版本
```bash
# 查看main分支的index.ts
git show main:miniprogram/pages/index/index.ts

# 查看feature/frontend-optimization分支的index.wxml
git show feature/frontend-optimization:miniprogram/pages/index/index.wxml

# 查看特定提交的文件
git show 7f49a09:miniprogram/pages/index/index.ts
```

### 对比不同版本
```bash
# 对比当前文件与main分支
git diff main -- miniprogram/pages/index/index.ts

# 对比两个分支
git diff main..feature/frontend-optimization -- miniprogram/pages/index/

# 查看文件的修改历史
git log --follow -- miniprogram/pages/index/index.ts
```

### 恢复特定文件
```bash
# 恢复main分支的index.ts到临时文件
git show main:miniprogram/pages/index/index.ts > /tmp/index_main.ts

# 恢复并直接覆盖当前文件（慎用！）
git checkout main -- miniprogram/pages/index/index.ts
```

---

## 📱 功能依赖关系

### 微信支付完整流程
```
前端：
1. getUserOpenId() → 获取OpenID
2. selectPackage() → 用户选择套餐
3. createPayment() → 创建支付订单
4. callWeChatPay() → 调用微信支付
5. updateUserPackage() → 更新用户套餐

后端API：
1. POST /api/wechat/auth/openid
2. POST /api/wechat/pay/create
3. 微信支付回调（后端处理）
```

### 用户系统完整流程
```
前端：
1. loadUserInfo() → 加载头像和昵称
2. loadUserStatus() → 加载等级和次数
3. checkUserRemainingCount() → 检查是否可用
4. enhanceImage() → 执行图片处理
5. useOneTime() → 扣除一次使用次数

本地存储：
- userAvatar
- userNickname
- userLevel
- remainingCount
- openid
```

---

## ⚠️ 重要提示

### 恢复页面后必须做的事情

1. **修改app.json**
   ```json
   {
     "pages": [
       "pages/splash/splash",
       "pages/home/home",        // 新增
       "pages/index/index",
       // ... 其他页面
     ]
   }
   ```

2. **修改启动页跳转**
   ```javascript
   // splash/splash.ts
   url: '/pages/home/home'  // 从index改为home
   ```

3. **测试页面跳转**
   - 启动页 → 首页 ✓
   - 首页 → 各功能页 ✓
   - 返回导航 ✓

### 恢复支付功能后必须做的事情

1. **确认后端API可用**
   - `/api/wechat/auth/openid`
   - `/api/wechat/pay/create`

2. **配置微信支付**
   - 商户号配置
   - 支付密钥配置
   - 支付回调URL

3. **测试支付流程**
   - OpenID获取 ✓
   - 订单创建 ✓
   - 支付调用 ✓
   - 支付回调 ✓

---

## 📚 相关文档

- [功能实现记录与恢复指南.md](./功能实现记录与恢复指南.md) - 详细的功能说明和代码示例
- [V1-MVP-实现总结.md](./V1-MVP-实现总结.md) - V1版本的实现总结
- [README.md](./README.md) - 项目总览
- [微信小程序调用指南.md](./微信小程序调用指南.md) - API调用文档
- [微信支付API调用指南.md](./微信支付API调用指南.md) - 支付集成文档

---

**更新时间**：2025年10月1日

