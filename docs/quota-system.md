# 纯前端额度控制系统

> **实施日期：** 2025-10-31  
> **版本：** v1.0  
> **类型：** 纯前端控制，无需服务器改动

---

## 📋 功能概述

### 核心理念
**信任用户，宽松控制，激励传播**

- 🎯 **每日基础额度：** 20 次免费使用
- 🎁 **分享奖励：** 分享者 +10 次，被分享者 +20 次
- 💎 **友好提示：** 超额不强制阻止，只显示提示
- 🔄 **自动重置：** 每日 0 点自动恢复基础额度
- 🚫 **零服务器改动：** 完全前端本地存储实现

### 设计目标
1. **对用户宽松：** 额度充足，不影响正常使用
2. **激励传播：** 分享有实际价值，促进用户增长
3. **实现简单：** 纯前端，无需服务器、数据库
4. **成本可控：** 包月服务器，技术用户能绕过也没关系

---

## 🏗️ 技术架构

### 文件结构

```
miniprogram/
├── utils/
│   └── quota.ts              # 额度管理工具类（新增）
└── pages/
    └── index/
        ├── index.ts          # 页面逻辑（已修改）
        ├── index.wxml        # 页面结构（已修改）
        └── index.wxss        # 页面样式（已修改）
```

### 核心组件

#### 1. QuotaManager 工具类 (`utils/quota.ts`)

**职责：** 所有额度相关的业务逻辑

**核心方法：**
```typescript
class QuotaManager {
  // 使用一次额度（返回 false 表示需要提示用户）
  useQuota(): boolean
  
  // 分享奖励（+10 次）
  shareReward(): void
  
  // 被邀请奖励（+20 次）
  inviteReward(): void
  
  // 获取剩余额度
  getRemaining(): number
  
  // 退还额度（处理失败时调用）
  refundQuota(): void
  
  // 获取总额度（基础 + 奖励）
  getTotal(): number
  
  // 获取已使用次数
  getUsed(): number
  
  // 获取额外获得的额度
  getBonus(): number
}
```

**数据存储：**
```typescript
interface QuotaData {
  date: string;      // 日期标识（YYYY-MM-DD）
  used: number;      // 已使用次数
  bonus: number;     // 额外获得次数
}
```

**Storage Key:** `quota_data`

---

#### 2. 页面逻辑集成 (`pages/index/index.ts`)

**新增方法：**

| 方法名 | 功能 | 调用时机 |
|--------|------|---------|
| `updateQuotaDisplay()` | 更新页面额度显示 | 页面加载、额度变化时 |
| `checkShareInvite()` | 检查是否通过分享进入 | 页面加载时 |
| `getDeviceId()` | 获取设备唯一ID | 分享、邀请检测时 |
| `proceedToProcess()` | 继续处理图片 | 额度检查通过后 |

**修改方法：**

| 方法名 | 修改内容 |
|--------|---------|
| `handleStartProcessing()` | 添加额度检查，显示友好提示 |
| `onShareAppMessage()` | 分享时 +10 次，携带设备ID参数 |
| `handleError()` | 处理失败时自动退还额度 |
| `attached()` | 初始化额度显示，检查分享进入 |

**数据字段：**
```typescript
data: {
  quotaRemaining: 20,   // 剩余额度
  quotaUsed: 0,         // 已使用次数
  quotaTotal: 20,       // 总额度
  quotaBonus: 0         // 额外获得额度
}
```

---

#### 3. UI 界面 (`pages/index/index.wxml`)

**额度显示卡片：**
```xml
<!-- 位置：头部下方，快速测试区域上方 -->
<view class="quota-card">
  <view class="quota-main">
    <view class="quota-icon">💎</view>
    <view class="quota-info">
      <text class="quota-title">今日剩余额度</text>
      <text class="quota-value">{{quotaRemaining}}/{{quotaTotal}} 次</text>
    </view>
  </view>
  
  <!-- 有额外奖励时显示 -->
  <view class="quota-hint" wx:if="{{quotaBonus > 0}}">
    <text class="quota-bonus-text">🎁 已获得 {{quotaBonus}} 次额外额度</text>
  </view>
  
  <!-- 额度不足警告（≤5 次） -->
  <view class="quota-hint" wx:if="{{quotaRemaining <= 5 && quotaBonus === 0}}">
    <text class="quota-warning-text">⚠️ 额度即将用完，分享可得 10 次额外额度</text>
  </view>
</view>
```

---

#### 4. 视觉样式 (`pages/index/index.wxss`)

**设计特点：**
- 粉色渐变背景（符合整体风格）
- 钻石图标脉冲动画（吸引注意）
- 渐变色数字显示（视觉重点）
- 淡入动画效果（流畅过渡）

**核心样式：**
```css
.quota-card {
  background: linear-gradient(135deg, #ffffff 0%, #fef3f8 100%);
  border-radius: 24rpx;
  padding: 32rpx;
  box-shadow: 0 8rpx 24rpx rgba(255, 154, 158, 0.15);
  animation: quotaCardFadeIn 0.5s ease-out;
}

.quota-value {
  font-size: 40rpx;
  font-weight: bold;
  background: linear-gradient(135deg, #ff6b9d 0%, #c77dff 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.quota-icon {
  font-size: 56rpx;
  animation: quotaIconPulse 2s ease-in-out infinite;
}
```

---

## 📐 核心规则

### 额度规则表

| 场景 | 额度变化 | 说明 |
|------|---------|------|
| 每日基础 | **20 次** | 每天 0 点自动重置 |
| 分享时 | **+10 次** | 立即到账（信任机制） |
| 被邀请 | **+20 次** | 通过分享链接进入 |
| 用完基础 | 友好提示 | 不强制阻止，可继续用额外额度 |
| 处理失败 | 自动退还 | 不扣除额度 |

### 触发逻辑

#### 1️⃣ 使用额度
```
触发时机：点击"立即变美"按钮
处理流程：
  ├─ 检查额度：QuotaManager.useQuota()
  ├─ 如果返回 false（刚好用完基础额度）
  │   └─ 显示友好提示弹窗
  │       ├─ 有额外额度：提示可继续使用
  │       └─ 无额外额度：提示分享获取
  └─ 如果返回 true
      └─ 继续处理图片
```

#### 2️⃣ 分享奖励
```
触发时机：点击"分享小程序"按钮
处理流程：
  ├─ QuotaManager.shareReward()  // +10 次
  ├─ 更新页面显示
  ├─ 提示"🎁 分享成功，+10 次额度"
  └─ 返回分享数据（携带 from=deviceId）
```

#### 3️⃣ 被邀请奖励
```
触发时机：页面加载时检测到 from 参数
处理流程：
  ├─ 获取分享者设备ID（from 参数）
  ├─ 检查：不是自己邀请自己
  ├─ 检查：今天未领取过这个分享
  ├─ QuotaManager.inviteReward()  // +20 次
  ├─ 记录已领取（防止重复）
  ├─ 更新页面显示
  └─ 弹窗："🎉 已获得 20 次免费额度"
```

#### 4️⃣ 失败退还
```
触发时机：图片处理失败时
处理流程：
  ├─ QuotaManager.refundQuota()  // -1 次使用
  ├─ 更新页面显示
  └─ 日志："处理失败，已退还额度"
```

---

## 👤 用户体验流程

### 场景 1：正常使用
```
┌─────────────────────────────────────┐
│ 1. 打开小程序                        │
│    └─ 显示：今日剩余额度 20/20 次    │
│                                      │
│ 2. 选择图片，点击"立即变美"           │
│    └─ 额度检查通过                   │
│    └─ 开始处理图片                   │
│                                      │
│ 3. 处理完成                          │
│    └─ 显示：今日剩余额度 19/20 次    │
│                                      │
│ 4. 继续使用...                       │
└─────────────────────────────────────┘
```

### 场景 2：分享获取额度
```
┌─────────────────────────────────────┐
│ 1. 点击"分享小程序"按钮               │
│    └─ 提示：🎁 分享成功，+10 次额度   │
│    └─ 显示：今日剩余额度 25/30 次    │
│                                      │
│ 2. 分享到微信好友                    │
│    └─ 分享链接：?from=device_xxx     │
│                                      │
│ 3. 每次分享都 +10 次（无上限）        │
└─────────────────────────────────────┘
```

### 场景 3：被邀请进入
```
┌─────────────────────────────────────┐
│ 1. 好友 A 分享链接给好友 B            │
│                                      │
│ 2. 好友 B 点击链接打开小程序          │
│    └─ 检测到 from=A 参数             │
│    └─ 弹窗：                         │
│        "🎉 欢迎使用超清魔法！         │
│         好友分享的礼物：              │
│         ✨ 已获得 20 次免费额度       │
│                                      │
│         快来体验变美之旅吧！"         │
│                                      │
│ 3. 好友 B 额度显示：40/40 次         │
│    （基础 20 + 邀请 20）              │
└─────────────────────────────────────┘
```

### 场景 4：用完基础额度
```
┌─────────────────────────────────────┐
│ 1. 已使用 20 次基础额度               │
│                                      │
│ 2. 点击"立即变美"                     │
│    └─ 弹窗：                         │
│        "💎 温馨提示                   │
│         今日基础额度已使用完毕         │
│                                      │
│         当前剩余：10 次（分享获得）"   │
│        [继续使用] [知道了]            │
│                                      │
│ 3. 点击"继续使用"                     │
│    └─ 正常处理图片（使用额外额度）     │
└─────────────────────────────────────┘
```

### 场景 5：完全用完
```
┌─────────────────────────────────────┐
│ 1. 基础 + 额外额度都用完              │
│                                      │
│ 2. 点击"立即变美"                     │
│    └─ 弹窗：                         │
│        "💎 温馨提示                   │
│         今日基础额度已使用完毕         │
│                                      │
│         🎁 分享给好友，你们各得额外    │
│            10 次                     │
│         或者明天 0 点后再来"          │
│        [立即分享] [知道了]            │
│                                      │
│ 3. 点击"立即分享"                     │
│    └─ 提示："请点击右上角分享"        │
└─────────────────────────────────────┘
```

---

## 🔒 防刷机制

### ✅ 已实现（轻度防护）

#### 1. 不能自己邀请自己
```typescript
if (fromDeviceId !== myDeviceId) {
  // 可以领取
}
```

#### 2. 每天同一分享只能领取一次
```typescript
const claimKey = `claimed_${fromDeviceId}_${new Date().toDateString()}`
const alreadyClaimed = wx.getStorageSync(claimKey)

if (!alreadyClaimed) {
  // 首次领取
  wx.setStorageSync(claimKey, true)
}
```

#### 3. 设备ID持久化
```typescript
let deviceId = wx.getStorageSync('device_uuid')
if (!deviceId) {
  deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
  wx.setStorageSync('device_uuid', deviceId)
}
```

---

### ❌ 未实现（信任用户）

| 可能的绕过方式 | 是否阻止 | 理由 |
|--------------|---------|------|
| 清理小程序缓存重置额度 | ❌ 否 | 大部分用户不知道如何操作 |
| 修改本地 Storage 数据 | ❌ 否 | 技术用户占比极小 |
| 直接调用 API（绕过前端） | ❌ 否 | 成本可控（包月服务器） |
| 多设备/小号刷额度 | ❌ 否 | 操作成本高，不影响体验 |

---

### 🎯 防刷哲学

**核心观点：**
> **99% 的用户不会刷，1% 能刷的用户成本可控**

**理由：**
1. **包月服务器：** 无论用多少次，成本固定
2. **额度充足：** 20 次基础 + 分享奖励，正常用户够用
3. **技术门槛：** 需要懂开发者工具、Storage、API
4. **操作成本：** 刷额度的时间成本 > 直接使用成本
5. **用户体验：** 复杂的防刷会影响 99% 正常用户

**策略：**
- ✅ 实施轻度防护（防止误操作）
- ✅ 信任大部分用户（宽松控制）
- ✅ 专注产品体验（而非防刷）
- ✅ 成本可控（即使被刷也不怕）

---

## 💾 数据存储结构

### Storage Keys

#### 1. 额度数据 (`quota_data`)
```json
{
  "date": "2025-10-31",
  "used": 5,
  "bonus": 10
}
```

**字段说明：**
- `date`: 日期标识（YYYY-MM-DD），用于判断是否需要重置
- `used`: 已使用次数
- `bonus`: 额外获得次数（通过分享获得）

**计算公式：**
- 总额度 = 20（基础）+ `bonus`
- 剩余额度 = 总额度 - `used`

---

#### 2. 设备ID (`device_uuid`)
```
"device_1730366400000_abc123xyz"
```

**生成规则：**
```typescript
'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
```

**用途：**
- 分享链接携带：`?from={deviceId}`
- 防止自己邀请自己
- 跟踪分享来源

---

#### 3. 已领取标记 (`claimed_{fromDeviceId}_{date}`)
```
Key: "claimed_device_xxx_Thu Oct 31 2025"
Value: true
```

**用途：**
- 防止重复领取同一分享
- 每天自动重置（日期变化后 key 不同）

**生命周期：**
- 创建时机：首次领取分享奖励
- 失效时机：跨天后（日期变化）

---

## 🧪 测试指南

### 基础功能测试

#### ✅ 测试1：额度初始化
```
操作：首次打开小程序
预期：
  - 额度卡片显示："今日剩余额度 20/20 次"
  - 不显示额外奖励提示
  - 不显示低额度警告
```

#### ✅ 测试2：使用额度
```
操作：处理一张图片
预期：
  - 处理成功后额度 -1
  - 显示："今日剩余额度 19/20 次"
```

#### ✅ 测试3：失败退还
```
操作：
  1. 记录当前额度
  2. 故意触发处理失败（如断网）
预期：
  - 额度恢复到原值（自动退还）
```

---

### 分享功能测试

#### ✅ 测试4：分享奖励
```
操作：
  1. 点击"分享小程序"按钮
  2. 分享到微信好友
预期：
  - 提示："🎁 分享成功，+10 次额度"
  - 额度增加 10 次
  - 显示："今日剩余额度 X/30 次"（30 = 20 + 10）
```

#### ✅ 测试5：分享链接
```
操作：查看分享链接的路径
预期：
  - 路径包含：?from=device_xxx
  - from 参数值 = 当前设备的 device_uuid
```

---

### 邀请功能测试

#### ✅ 测试6：被邀请进入
```
准备：使用两个设备/小号（A 和 B）
操作：
  1. 设备A 分享链接
  2. 设备B 点击链接打开小程序
预期（设备B）：
  - 弹窗："🎉 欢迎使用超清魔法！
           已获得 20 次免费额度"
  - 额度显示："40/40 次"（20 基础 + 20 邀请）
  - 额外奖励提示："🎁 已获得 20 次额外额度"
```

#### ✅ 测试7：防止重复领取
```
操作：
  1. 设备B 通过设备A 的分享进入（首次）
  2. 关闭小程序
  3. 设备B 再次通过设备A 的分享进入（第二次）
预期：
  - 第二次不再弹窗
  - 不再增加额度
  - 控制台日志："今天已经领取过这个分享了"
```

#### ✅ 测试8：防止自己邀请自己
```
操作：
  1. 设备A 分享链接
  2. 设备A 自己点击这个链接
预期：
  - 不弹窗
  - 不增加额度
```

---

### 额度用尽测试

#### ✅ 测试9：基础额度用尽
```
准备：修改 Storage，设置 used=20, bonus=10
操作：点击"立即变美"
预期：
  - 弹窗："💎 温馨提示
           今日基础额度已使用完毕
           
           当前剩余：10 次（分享获得）"
  - 按钮：[继续使用] [知道了]
  - 点击"继续使用"后正常处理
```

#### ✅ 测试10：完全用尽
```
准备：修改 Storage，设置 used=20, bonus=0
操作：点击"立即变美"
预期：
  - 弹窗："💎 温馨提示
           今日基础额度已使用完毕
           
           🎁 分享给好友，你们各得额外 10 次
           或者明天 0 点后再来"
  - 按钮：[立即分享] [知道了]
  - 点击"立即分享"提示："请点击右上角分享"
```

---

### 跨天重置测试

#### ✅ 测试11：日期重置
```
操作：
  1. 使用一些额度（如 used=10）
  2. 修改系统日期到明天
  3. 重新打开小程序
预期：
  - 额度重置为："20/20 次"
  - 额外奖励清零（bonus=0）
  - 已使用次数清零（used=0）
```

---

### 开发者工具调试

#### Storage 查看
```
开发者工具 → 工具 → 缓存 → Storage

查看 Key：
  - quota_data          # 额度数据
  - device_uuid         # 设备ID
  - claimed_xxx_xxx     # 已领取标记
```

#### 手动修改额度（测试用）
```javascript
// 开发者工具 → Console

// 1. 设置额度用尽
wx.setStorageSync('quota_data', {
  date: new Date().toDateString(),
  used: 20,
  bonus: 0
})

// 2. 设置有额外额度
wx.setStorageSync('quota_data', {
  date: new Date().toDateString(),
  used: 20,
  bonus: 10
})

// 3. 重置额度
wx.removeStorageSync('quota_data')

// 4. 清除已领取标记（测试重复领取）
wx.clearStorageSync()
```

---

## 📊 数据监控建议

### 关键指标

虽然是纯前端实现，但可以通过后端日志观察：

| 指标 | 计算方式 | 用途 |
|------|---------|------|
| **日均调用量** | 统计 API 请求次数 | 判断额度是否充足 |
| **分享转化率** | 带 from 参数的访问 / 总访问 | 评估分享效果 |
| **用户留存率** | 次日回访用户 / 首日用户 | 判断产品粘性 |

### 优化建议

**如果日均调用量 > 30：**
- 考虑提高基础额度到 30 次

**如果分享转化率 < 5%：**
- 优化分享文案
- 提高分享奖励（如 +20 次）

**如果用户留存率 < 20%：**
- 优化产品体验
- 增加分享激励

---

## 🔧 维护说明

### 修改额度配置

#### 修改基础额度
```typescript
// miniprogram/utils/quota.ts

class QuotaManager {
  private BASE_QUOTA = 20;  // 修改这里：20 → 30
}
```

#### 修改分享奖励
```typescript
// miniprogram/utils/quota.ts

shareReward(): void {
  const data = this.getTodayData();
  data.bonus += 10;  // 修改这里：10 → 20
  wx.setStorageSync(this.STORAGE_KEY, data);
}
```

#### 修改邀请奖励
```typescript
// miniprogram/utils/quota.ts

inviteReward(): void {
  const data = this.getTodayData();
  data.bonus += 20;  // 修改这里：20 → 30
  wx.setStorageSync(this.STORAGE_KEY, data);
}
```

---

### 常见问题处理

#### Q1: 用户反馈额度不足
```
原因分析：
  - 基础额度太低（20 次/天）
  - 用户不知道可以分享获取

解决方案：
  1. 提高基础额度（20 → 30）
  2. 优化低额度警告提示
  3. 在更多位置引导分享
```

#### Q2: 分享转化率低
```
原因分析：
  - 分享文案不吸引人
  - 分享奖励不够诱人
  - 分享流程不顺畅

解决方案：
  1. 优化分享文案
  2. 提高分享奖励（+10 → +20）
  3. 提高被邀请奖励（+20 → +30）
  4. 添加分享成功动画/庆祝效果
```

#### Q3: 技术用户刷额度
```
原因分析：
  - 清理缓存重置
  - 修改 Storage
  - 直接调用 API

解决方案：
  1. 不处理（成本可控）
  2. 如果真的影响太大：
     - 添加服务器端校验
     - 使用 JWT Token 机制
     - 记录设备指纹（openid）
```

---

### 升级方案

#### 方案1：保持现状（推荐）
```
优点：
  - 实现简单，维护容易
  - 成本可控
  - 用户体验好

缺点：
  - 技术用户能绕过
  
适用场景：
  - 包月服务器
  - 用户量 < 10000
  - 对额度不敏感
```

#### 方案2：轻度服务器校验
```
改动：
  - 服务器记录每个 openid 的使用次数
  - 超过阈值返回 429 Too Many Requests
  
优点：
  - 防止滥用
  - 仍然无需登录

缺点：
  - 需要改动服务器
  - 增加数据库查询

适用场景：
  - 用户量大（> 10000）
  - 服务器成本敏感
```

#### 方案3：完整额度系统
```
改动：
  - JWT Token 机制
  - 服务器端完整校验
  - 用户账号系统

优点：
  - 完全防刷
  - 数据可追溯

缺点：
  - 复杂度高
  - 需要登录（影响体验）

适用场景：
  - 商业化产品
  - 对额度非常敏感
```

---

## 📝 提交记录

**Commit Message:**
```
[新功能] 实现纯前端额度控制系统

核心功能：
1. 每日基础额度：20 次
2. 超过 20 次：友好提示，不强制阻止
3. 分享奖励：分享者 +10 次，被分享者 +20 次
4. 服务器：完全不改动，只处理图片

文件变更：
- 新增：miniprogram/utils/quota.ts
- 修改：miniprogram/pages/index/index.ts
- 修改：miniprogram/pages/index/index.wxml
- 修改：miniprogram/pages/index/index.wxss
```

**Git Tag:** 建议在测试完成后打 tag
```bash
git tag -a v1.0.5 -m "添加纯前端额度控制系统"
```

---

## 🎉 总结

### 核心优势
1. ✅ **零服务器改动** - 完全前端控制
2. ✅ **简单可靠** - 约 400 行代码
3. ✅ **用户友好** - 不强制，只提示
4. ✅ **激励传播** - 分享有实际价值
5. ✅ **成本可控** - 包月服务器不怕刷

### 用户价值
- 🎁 **免费使用** - 20 次/天基础额度
- 📱 **无需登录** - 自动识别设备
- 🔄 **每日重置** - 公平合理
- 🎉 **分享有奖** - 实际获得额外额度

### 技术价值
- 🚀 **快速实施** - 1 天完成
- 🔧 **易于维护** - 逻辑清晰
- 📊 **数据透明** - 本地存储可查
- 🔄 **易于调整** - 参数配置化

---

**文档版本：** v1.0  
**最后更新：** 2025-10-31  
**维护者：** 开发团队

