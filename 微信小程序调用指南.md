# 微信小程序调用指南

## 📱 概述

本文档详细说明微信小程序如何调用 `https://gongjuxiang.work/api/v1/` 的HTTPS接口，实现照片超分辨率增强功能。

## 🔧 接口列表

### 基础信息
- **网关地址**: `https://gongjuxiang.work/api/v1/`
- **协议**: HTTPS
- **支持格式**: JSON
- **跨域**: 已配置CORS支持

### 可用接口

| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 图片增强 | POST | `/api/v1/enhance` | 上传图片进行AI增强处理 |
| 状态查询 | GET | `/api/v1/status/{task_id}` | 查询处理任务状态 |
| 结果下载 | GET | `/api/v1/download/{task_id}` | 下载处理后的图片 |
| 健康检查 | GET | `/api/v1/health` | 检查服务状态 |
| 配置信息 | GET | `/api/v1/config` | 获取网关配置信息 |
| API信息 | GET | `/api/v1/info` | 获取API详细信息 |

## 🚀 快速开始

### 1. 配置小程序域名

在小程序后台配置服务器域名：

```
request合法域名: https://gongjuxiang.work
```

### 2. 基础调用示例

```javascript
// 检查服务状态
wx.request({
  url: 'https://gongjuxiang.work/api/v1/health',
  method: 'GET',
  success: function(res) {
    console.log('服务状态:', res.data);
  }
});
```

## 📸 图片增强功能

### 上传图片进行增强

```javascript
// 选择图片
wx.chooseImage({
  count: 1,
  sizeType: ['original', 'compressed'],
  sourceType: ['album', 'camera'],
  success: function(res) {
    const tempFilePath = res.tempFilePaths[0];
    enhanceImage(tempFilePath);
  }
});

// 增强图片
function enhanceImage(imagePath) {
  wx.showLoading({
    title: '正在处理...'
  });

  wx.uploadFile({
    url: 'https://gongjuxiang.work/api/v1/enhance',
    filePath: imagePath,
    name: 'file',
    formData: {
      'tile_size': '400',
      'quality_level': 'high'
    },
    success: function(res) {
      wx.hideLoading();
      const data = JSON.parse(res.data);
      
      if (data.task_id) {
        // 异步处理，开始轮询状态
        pollTaskStatus(data.task_id);
      } else {
        // 同步处理完成
        showResult(data.enhanced_image);
      }
    },
    fail: function(error) {
      wx.hideLoading();
      wx.showToast({
        title: '上传失败',
        icon: 'error'
      });
      console.error('上传失败:', error);
    }
  });
}
```

### 轮询任务状态

```javascript
function pollTaskStatus(taskId) {
  const maxAttempts = 60; // 最大轮询次数
  const interval = 5000;   // 轮询间隔5秒
  let attempts = 0;

  const poll = () => {
    attempts++;
    
    wx.request({
      url: `https://gongjuxiang.work/api/v1/status/${taskId}`,
      method: 'GET',
      success: function(res) {
        const data = res.data;
        
        if (data.status === 'completed') {
          // 处理完成，下载结果
          downloadResult(taskId);
        } else if (data.status === 'failed') {
          // 处理失败
          wx.hideLoading();
          wx.showToast({
            title: '处理失败',
            icon: 'error'
          });
        } else if (data.status === 'processing' || data.status === 'queued') {
          // 继续轮询
          if (attempts < maxAttempts) {
            setTimeout(poll, interval);
          } else {
            wx.hideLoading();
            wx.showToast({
              title: '处理超时',
              icon: 'error'
            });
          }
        }
      },
      fail: function(error) {
        wx.hideLoading();
        wx.showToast({
          title: '查询失败',
          icon: 'error'
        });
        console.error('查询状态失败:', error);
      }
    });
  };

  poll();
}
```

### 下载处理结果

```javascript
function downloadResult(taskId) {
  wx.request({
    url: `https://gongjuxiang.work/api/v1/download/${taskId}`,
    method: 'GET',
    responseType: 'arraybuffer',
    success: function(res) {
      // 将ArrayBuffer转换为临时文件
      const fs = wx.getFileSystemManager();
      const filePath = `${wx.env.USER_DATA_PATH}/enhanced_${taskId}.jpg`;
      
      fs.writeFile({
        filePath: filePath,
        data: res.data,
        success: function() {
          wx.hideLoading();
          showResult(filePath);
        },
        fail: function(error) {
          wx.hideLoading();
          wx.showToast({
            title: '保存失败',
            icon: 'error'
          });
          console.error('保存失败:', error);
        }
      });
    },
    fail: function(error) {
      wx.hideLoading();
      wx.showToast({
        title: '下载失败',
        icon: 'error'
      });
      console.error('下载失败:', error);
    }
  });
}
```

### 显示处理结果

```javascript
function showResult(imagePath) {
  wx.previewImage({
    urls: [imagePath],
    current: imagePath
  });
  
  // 或者保存到相册
  wx.saveImageToPhotosAlbum({
    filePath: imagePath,
    success: function() {
      wx.showToast({
        title: '保存成功',
        icon: 'success'
      });
    },
    fail: function() {
      wx.showToast({
        title: '保存失败',
        icon: 'error'
      });
    }
  });
}
```

## 🔄 批量处理

### 批量上传多张图片

```javascript
function batchEnhanceImages() {
  wx.chooseImage({
    count: 9, // 最多选择9张
    sizeType: ['original', 'compressed'],
    sourceType: ['album', 'camera'],
    success: function(res) {
      const imagePaths = res.tempFilePaths;
      processBatchImages(imagePaths);
    }
  });
}

function processBatchImages(imagePaths) {
  wx.showLoading({
    title: `处理中 0/${imagePaths.length}`
  });

  let completedCount = 0;
  const results = [];

  imagePaths.forEach((imagePath, index) => {
    wx.uploadFile({
      url: 'https://gongjuxiang.work/api/v1/enhance',
      filePath: imagePath,
      name: 'file',
      formData: {
        'tile_size': '400',
        'quality_level': 'high'
      },
      success: function(res) {
        const data = JSON.parse(res.data);
        if (data.task_id) {
          pollBatchTaskStatus(data.task_id, index, results);
        }
      },
      fail: function(error) {
        completedCount++;
        updateProgress();
        console.error(`第${index + 1}张图片处理失败:`, error);
      }
    });
  });
}

function pollBatchTaskStatus(taskId, index, results) {
  const poll = () => {
    wx.request({
      url: `https://gongjuxiang.work/api/v1/status/${taskId}`,
      method: 'GET',
      success: function(res) {
        const data = res.data;
        
        if (data.status === 'completed') {
          results[index] = { taskId, status: 'completed' };
          completedCount++;
          updateProgress();
          
          if (completedCount === results.length) {
            wx.hideLoading();
            showBatchResults(results);
          }
        } else if (data.status === 'failed') {
          results[index] = { taskId, status: 'failed' };
          completedCount++;
          updateProgress();
        } else {
          setTimeout(poll, 5000);
        }
      }
    });
  };
  
  poll();
}

function updateProgress() {
  wx.showLoading({
    title: `处理中 ${completedCount}/${results.length}`
  });
}
```

## 🛠️ 工具函数

### 通用请求封装

```javascript
// 通用请求函数
function apiRequest(options) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `https://gongjuxiang.work/api/v1${options.path}`,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Content-Type': 'application/json',
        ...options.header
      },
      success: function(res) {
        if (res.statusCode === 200) {
          resolve(res.data);
        } else {
          reject(new Error(`请求失败: ${res.statusCode}`));
        }
      },
      fail: function(error) {
        reject(error);
      }
    });
  });
}

// 使用示例
async function checkServiceStatus() {
  try {
    const result = await apiRequest({
      path: '/health',
      method: 'GET'
    });
    console.log('服务状态:', result);
  } catch (error) {
    console.error('检查服务状态失败:', error);
  }
}
```

### 错误处理

```javascript
function handleApiError(error, defaultMessage = '操作失败') {
  console.error('API错误:', error);
  
  let message = defaultMessage;
  
  if (error.errMsg) {
    if (error.errMsg.includes('timeout')) {
      message = '请求超时，请重试';
    } else if (error.errMsg.includes('fail')) {
      message = '网络连接失败';
    }
  }
  
  wx.showToast({
    title: message,
    icon: 'error',
    duration: 2000
  });
}
```

## 📋 完整示例页面

### WXML结构

```xml
<view class="container">
  <view class="header">
    <text class="title">AI照片增强</text>
    <text class="subtitle">让每一张照片都变得更加清晰</text>
  </view>
  
  <view class="upload-area" bindtap="chooseImage">
    <image class="upload-icon" src="/images/upload.png"></image>
    <text class="upload-text">点击选择图片</text>
  </view>
  
  <view class="result-area" wx:if="{{resultImage}}">
    <text class="result-title">处理结果</text>
    <image class="result-image" src="{{resultImage}}" mode="aspectFit"></image>
    <button class="save-btn" bindtap="saveImage">保存到相册</button>
  </view>
  
  <view class="loading" wx:if="{{isLoading}}">
    <text>{{loadingText}}</text>
  </view>
</view>
```

### WXSS样式

```css
.container {
  padding: 20rpx;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.header {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  display: block;
  font-size: 48rpx;
  font-weight: bold;
  color: white;
  margin-bottom: 20rpx;
}

.subtitle {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.8);
}

.upload-area {
  background: white;
  border-radius: 20rpx;
  padding: 80rpx 40rpx;
  text-align: center;
  margin-bottom: 40rpx;
  box-shadow: 0 10rpx 30rpx rgba(0, 0, 0, 0.1);
}

.upload-icon {
  width: 120rpx;
  height: 120rpx;
  margin-bottom: 20rpx;
}

.upload-text {
  font-size: 32rpx;
  color: #666;
}

.result-area {
  background: white;
  border-radius: 20rpx;
  padding: 40rpx;
  margin-bottom: 40rpx;
}

.result-title {
  display: block;
  font-size: 36rpx;
  font-weight: bold;
  margin-bottom: 30rpx;
  color: #333;
}

.result-image {
  width: 100%;
  height: 600rpx;
  border-radius: 10rpx;
  margin-bottom: 30rpx;
}

.save-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50rpx;
  padding: 20rpx 60rpx;
}

.loading {
  text-align: center;
  color: white;
  font-size: 32rpx;
}
```

### JS逻辑

```javascript
Page({
  data: {
    resultImage: '',
    isLoading: false,
    loadingText: '正在处理...'
  },

  // 选择图片
  chooseImage() {
    wx.chooseImage({
      count: 1,
      sizeType: ['original'],
      sourceType: ['album', 'camera'],
      success: (res) => {
        this.enhanceImage(res.tempFilePaths[0]);
      }
    });
  },

  // 增强图片
  enhanceImage(imagePath) {
    this.setData({
      isLoading: true,
      loadingText: '正在上传...'
    });

    wx.uploadFile({
      url: 'https://gongjuxiang.work/api/v1/enhance',
      filePath: imagePath,
      name: 'file',
      formData: {
        'tile_size': '400',
        'quality_level': 'high'
      },
      success: (res) => {
        const data = JSON.parse(res.data);
        
        if (data.task_id) {
          this.setData({
            loadingText: '正在处理...'
          });
          this.pollTaskStatus(data.task_id);
        } else {
          this.setData({
            isLoading: false,
            resultImage: data.enhanced_image
          });
        }
      },
      fail: (error) => {
        this.setData({ isLoading: false });
        this.handleError(error, '上传失败');
      }
    });
  },

  // 轮询任务状态
  pollTaskStatus(taskId) {
    const maxAttempts = 60;
    const interval = 5000;
    let attempts = 0;

    const poll = () => {
      attempts++;
      
      wx.request({
        url: `https://gongjuxiang.work/api/v1/status/${taskId}`,
        method: 'GET',
        success: (res) => {
          const data = res.data;
          
          if (data.status === 'completed') {
            this.downloadResult(taskId);
          } else if (data.status === 'failed') {
            this.setData({ isLoading: false });
            this.handleError(null, '处理失败');
          } else if (attempts < maxAttempts) {
            setTimeout(poll, interval);
          } else {
            this.setData({ isLoading: false });
            this.handleError(null, '处理超时');
          }
        },
        fail: (error) => {
          this.setData({ isLoading: false });
          this.handleError(error, '查询状态失败');
        }
      });
    };

    poll();
  },

  // 下载结果
  downloadResult(taskId) {
    wx.request({
      url: `https://gongjuxiang.work/api/v1/download/${taskId}`,
      method: 'GET',
      responseType: 'arraybuffer',
      success: (res) => {
        const fs = wx.getFileSystemManager();
        const filePath = `${wx.env.USER_DATA_PATH}/enhanced_${taskId}.jpg`;
        
        fs.writeFile({
          filePath: filePath,
          data: res.data,
          success: () => {
            this.setData({
              isLoading: false,
              resultImage: filePath
            });
          },
          fail: (error) => {
            this.setData({ isLoading: false });
            this.handleError(error, '保存失败');
          }
        });
      },
      fail: (error) => {
        this.setData({ isLoading: false });
        this.handleError(error, '下载失败');
      }
    });
  },

  // 保存图片
  saveImage() {
    wx.saveImageToPhotosAlbum({
      filePath: this.data.resultImage,
      success: () => {
        wx.showToast({
          title: '保存成功',
          icon: 'success'
        });
      },
      fail: () => {
        wx.showToast({
          title: '保存失败',
          icon: 'error'
        });
      }
    });
  },

  // 错误处理
  handleError(error, defaultMessage) {
    console.error('错误:', error);
    wx.showToast({
      title: defaultMessage,
      icon: 'error'
    });
  }
});
```

## 🔒 安全注意事项

### 1. 域名配置
- 确保在小程序后台正确配置 `https://gongjuxiang.work` 为合法域名
- 不要使用IP地址，必须使用HTTPS域名

### 2. 文件大小限制
- 单张图片建议不超过10MB
- 批量处理建议不超过5张图片

### 3. 错误处理
- 始终处理网络请求失败的情况
- 提供用户友好的错误提示
- 记录错误日志便于调试

### 4. 用户体验
- 显示处理进度
- 提供取消操作
- 优化加载状态显示

## 📞 技术支持

如果在调用过程中遇到问题，可以：

1. 检查小程序后台域名配置
2. 查看控制台错误信息
3. 测试API接口连通性
4. 联系技术支持

---

**API网关地址**: `https://gongjuxiang.work/api/v1/`  
**文档更新时间**: 2025年9月21日  
**版本**: v1.0.0
