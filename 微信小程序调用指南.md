# å¾®ä¿¡å°ç¨‹åºè°ƒç”¨æŒ‡å—

## ğŸ“± æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¾®ä¿¡å°ç¨‹åºå¦‚ä½•è°ƒç”¨ `https://gongjuxiang.work/api/v1/` çš„HTTPSæ¥å£ï¼Œå®ç°ç…§ç‰‡è¶…åˆ†è¾¨ç‡å¢å¼ºåŠŸèƒ½ã€‚

## ğŸ”§ æ¥å£åˆ—è¡¨

### åŸºç¡€ä¿¡æ¯
- **ç½‘å…³åœ°å€**: `https://gongjuxiang.work/api/v1/`
- **åè®®**: HTTPS
- **æ”¯æŒæ ¼å¼**: JSON
- **è·¨åŸŸ**: å·²é…ç½®CORSæ”¯æŒ

### å¯ç”¨æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|------|
| å›¾ç‰‡å¢å¼º | POST | `/api/v1/enhance` | ä¸Šä¼ å›¾ç‰‡è¿›è¡ŒAIå¢å¼ºå¤„ç† |
| çŠ¶æ€æŸ¥è¯¢ | GET | `/api/v1/status/{task_id}` | æŸ¥è¯¢å¤„ç†ä»»åŠ¡çŠ¶æ€ |
| ç»“æœä¸‹è½½ | GET | `/api/v1/download/{task_id}` | ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡ |
| å¥åº·æ£€æŸ¥ | GET | `/api/v1/health` | æ£€æŸ¥æœåŠ¡çŠ¶æ€ |
| é…ç½®ä¿¡æ¯ | GET | `/api/v1/config` | è·å–ç½‘å…³é…ç½®ä¿¡æ¯ |
| APIä¿¡æ¯ | GET | `/api/v1/info` | è·å–APIè¯¦ç»†ä¿¡æ¯ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®å°ç¨‹åºåŸŸå

åœ¨å°ç¨‹åºåå°é…ç½®æœåŠ¡å™¨åŸŸåï¼š

```
requeståˆæ³•åŸŸå: https://gongjuxiang.work
```

### 2. åŸºç¡€è°ƒç”¨ç¤ºä¾‹

```javascript
// æ£€æŸ¥æœåŠ¡çŠ¶æ€
wx.request({
  url: 'https://gongjuxiang.work/api/v1/health',
  method: 'GET',
  success: function(res) {
    console.log('æœåŠ¡çŠ¶æ€:', res.data);
  }
});
```

## ğŸ“¸ å›¾ç‰‡å¢å¼ºåŠŸèƒ½

### ä¸Šä¼ å›¾ç‰‡è¿›è¡Œå¢å¼º

```javascript
// é€‰æ‹©å›¾ç‰‡
wx.chooseImage({
  count: 1,
  sizeType: ['original', 'compressed'],
  sourceType: ['album', 'camera'],
  success: function(res) {
    const tempFilePath = res.tempFilePaths[0];
    enhanceImage(tempFilePath);
  }
});

// å¢å¼ºå›¾ç‰‡
function enhanceImage(imagePath) {
  wx.showLoading({
    title: 'æ­£åœ¨å¤„ç†...'
  });

  wx.uploadFile({
    url: 'https://gongjuxiang.work/api/v1/enhance',
    filePath: imagePath,
    name: 'file',
    formData: {
      'tile_size': '400',
      'quality_level': 'high'
    },
    success: function(res) {
      wx.hideLoading();
      const data = JSON.parse(res.data);
      
      if (data.task_id) {
        // å¼‚æ­¥å¤„ç†ï¼Œå¼€å§‹è½®è¯¢çŠ¶æ€
        pollTaskStatus(data.task_id);
      } else {
        // åŒæ­¥å¤„ç†å®Œæˆ
        showResult(data.enhanced_image);
      }
    },
    fail: function(error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ä¸Šä¼ å¤±è´¥',
        icon: 'error'
      });
      console.error('ä¸Šä¼ å¤±è´¥:', error);
    }
  });
}
```

### è½®è¯¢ä»»åŠ¡çŠ¶æ€

```javascript
function pollTaskStatus(taskId) {
  const maxAttempts = 60; // æœ€å¤§è½®è¯¢æ¬¡æ•°
  const interval = 5000;   // è½®è¯¢é—´éš”5ç§’
  let attempts = 0;

  const poll = () => {
    attempts++;
    
    wx.request({
      url: `https://gongjuxiang.work/api/v1/status/${taskId}`,
      method: 'GET',
      success: function(res) {
        const data = res.data;
        
        if (data.status === 'completed') {
          // å¤„ç†å®Œæˆï¼Œä¸‹è½½ç»“æœ
          downloadResult(taskId);
        } else if (data.status === 'failed') {
          // å¤„ç†å¤±è´¥
          wx.hideLoading();
          wx.showToast({
            title: 'å¤„ç†å¤±è´¥',
            icon: 'error'
          });
        } else if (data.status === 'processing' || data.status === 'queued') {
          // ç»§ç»­è½®è¯¢
          if (attempts < maxAttempts) {
            setTimeout(poll, interval);
          } else {
            wx.hideLoading();
            wx.showToast({
              title: 'å¤„ç†è¶…æ—¶',
              icon: 'error'
            });
          }
        }
      },
      fail: function(error) {
        wx.hideLoading();
        wx.showToast({
          title: 'æŸ¥è¯¢å¤±è´¥',
          icon: 'error'
        });
        console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', error);
      }
    });
  };

  poll();
}
```

### ä¸‹è½½å¤„ç†ç»“æœ

```javascript
function downloadResult(taskId) {
  wx.request({
    url: `https://gongjuxiang.work/api/v1/download/${taskId}`,
    method: 'GET',
    responseType: 'arraybuffer',
    success: function(res) {
      // å°†ArrayBufferè½¬æ¢ä¸ºä¸´æ—¶æ–‡ä»¶
      const fs = wx.getFileSystemManager();
      const filePath = `${wx.env.USER_DATA_PATH}/enhanced_${taskId}.jpg`;
      
      fs.writeFile({
        filePath: filePath,
        data: res.data,
        success: function() {
          wx.hideLoading();
          showResult(filePath);
        },
        fail: function(error) {
          wx.hideLoading();
          wx.showToast({
            title: 'ä¿å­˜å¤±è´¥',
            icon: 'error'
          });
          console.error('ä¿å­˜å¤±è´¥:', error);
        }
      });
    },
    fail: function(error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ä¸‹è½½å¤±è´¥',
        icon: 'error'
      });
      console.error('ä¸‹è½½å¤±è´¥:', error);
    }
  });
}
```

### æ˜¾ç¤ºå¤„ç†ç»“æœ

```javascript
function showResult(imagePath) {
  wx.previewImage({
    urls: [imagePath],
    current: imagePath
  });
  
  // æˆ–è€…ä¿å­˜åˆ°ç›¸å†Œ
  wx.saveImageToPhotosAlbum({
    filePath: imagePath,
    success: function() {
      wx.showToast({
        title: 'ä¿å­˜æˆåŠŸ',
        icon: 'success'
      });
    },
    fail: function() {
      wx.showToast({
        title: 'ä¿å­˜å¤±è´¥',
        icon: 'error'
      });
    }
  });
}
```

## ğŸ”„ æ‰¹é‡å¤„ç†

### æ‰¹é‡ä¸Šä¼ å¤šå¼ å›¾ç‰‡

```javascript
function batchEnhanceImages() {
  wx.chooseImage({
    count: 9, // æœ€å¤šé€‰æ‹©9å¼ 
    sizeType: ['original', 'compressed'],
    sourceType: ['album', 'camera'],
    success: function(res) {
      const imagePaths = res.tempFilePaths;
      processBatchImages(imagePaths);
    }
  });
}

function processBatchImages(imagePaths) {
  wx.showLoading({
    title: `å¤„ç†ä¸­ 0/${imagePaths.length}`
  });

  let completedCount = 0;
  const results = [];

  imagePaths.forEach((imagePath, index) => {
    wx.uploadFile({
      url: 'https://gongjuxiang.work/api/v1/enhance',
      filePath: imagePath,
      name: 'file',
      formData: {
        'tile_size': '400',
        'quality_level': 'high'
      },
      success: function(res) {
        const data = JSON.parse(res.data);
        if (data.task_id) {
          pollBatchTaskStatus(data.task_id, index, results);
        }
      },
      fail: function(error) {
        completedCount++;
        updateProgress();
        console.error(`ç¬¬${index + 1}å¼ å›¾ç‰‡å¤„ç†å¤±è´¥:`, error);
      }
    });
  });
}

function pollBatchTaskStatus(taskId, index, results) {
  const poll = () => {
    wx.request({
      url: `https://gongjuxiang.work/api/v1/status/${taskId}`,
      method: 'GET',
      success: function(res) {
        const data = res.data;
        
        if (data.status === 'completed') {
          results[index] = { taskId, status: 'completed' };
          completedCount++;
          updateProgress();
          
          if (completedCount === results.length) {
            wx.hideLoading();
            showBatchResults(results);
          }
        } else if (data.status === 'failed') {
          results[index] = { taskId, status: 'failed' };
          completedCount++;
          updateProgress();
        } else {
          setTimeout(poll, 5000);
        }
      }
    });
  };
  
  poll();
}

function updateProgress() {
  wx.showLoading({
    title: `å¤„ç†ä¸­ ${completedCount}/${results.length}`
  });
}
```

## ğŸ› ï¸ å·¥å…·å‡½æ•°

### é€šç”¨è¯·æ±‚å°è£…

```javascript
// é€šç”¨è¯·æ±‚å‡½æ•°
function apiRequest(options) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `https://gongjuxiang.work/api/v1${options.path}`,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Content-Type': 'application/json',
        ...options.header
      },
      success: function(res) {
        if (res.statusCode === 200) {
          resolve(res.data);
        } else {
          reject(new Error(`è¯·æ±‚å¤±è´¥: ${res.statusCode}`));
        }
      },
      fail: function(error) {
        reject(error);
      }
    });
  });
}

// ä½¿ç”¨ç¤ºä¾‹
async function checkServiceStatus() {
  try {
    const result = await apiRequest({
      path: '/health',
      method: 'GET'
    });
    console.log('æœåŠ¡çŠ¶æ€:', result);
  } catch (error) {
    console.error('æ£€æŸ¥æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
  }
}
```

### é”™è¯¯å¤„ç†

```javascript
function handleApiError(error, defaultMessage = 'æ“ä½œå¤±è´¥') {
  console.error('APIé”™è¯¯:', error);
  
  let message = defaultMessage;
  
  if (error.errMsg) {
    if (error.errMsg.includes('timeout')) {
      message = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
    } else if (error.errMsg.includes('fail')) {
      message = 'ç½‘ç»œè¿æ¥å¤±è´¥';
    }
  }
  
  wx.showToast({
    title: message,
    icon: 'error',
    duration: 2000
  });
}
```

## ğŸ“‹ å®Œæ•´ç¤ºä¾‹é¡µé¢

### WXMLç»“æ„

```xml
<view class="container">
  <view class="header">
    <text class="title">AIç…§ç‰‡å¢å¼º</text>
    <text class="subtitle">è®©æ¯ä¸€å¼ ç…§ç‰‡éƒ½å˜å¾—æ›´åŠ æ¸…æ™°</text>
  </view>
  
  <view class="upload-area" bindtap="chooseImage">
    <image class="upload-icon" src="/images/upload.png"></image>
    <text class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</text>
  </view>
  
  <view class="result-area" wx:if="{{resultImage}}">
    <text class="result-title">å¤„ç†ç»“æœ</text>
    <image class="result-image" src="{{resultImage}}" mode="aspectFit"></image>
    <button class="save-btn" bindtap="saveImage">ä¿å­˜åˆ°ç›¸å†Œ</button>
  </view>
  
  <view class="loading" wx:if="{{isLoading}}">
    <text>{{loadingText}}</text>
  </view>
</view>
```

### WXSSæ ·å¼

```css
.container {
  padding: 20rpx;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.header {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  display: block;
  font-size: 48rpx;
  font-weight: bold;
  color: white;
  margin-bottom: 20rpx;
}

.subtitle {
  font-size: 28rpx;
  color: rgba(255, 255, 255, 0.8);
}

.upload-area {
  background: white;
  border-radius: 20rpx;
  padding: 80rpx 40rpx;
  text-align: center;
  margin-bottom: 40rpx;
  box-shadow: 0 10rpx 30rpx rgba(0, 0, 0, 0.1);
}

.upload-icon {
  width: 120rpx;
  height: 120rpx;
  margin-bottom: 20rpx;
}

.upload-text {
  font-size: 32rpx;
  color: #666;
}

.result-area {
  background: white;
  border-radius: 20rpx;
  padding: 40rpx;
  margin-bottom: 40rpx;
}

.result-title {
  display: block;
  font-size: 36rpx;
  font-weight: bold;
  margin-bottom: 30rpx;
  color: #333;
}

.result-image {
  width: 100%;
  height: 600rpx;
  border-radius: 10rpx;
  margin-bottom: 30rpx;
}

.save-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 50rpx;
  padding: 20rpx 60rpx;
}

.loading {
  text-align: center;
  color: white;
  font-size: 32rpx;
}
```

### JSé€»è¾‘

```javascript
Page({
  data: {
    resultImage: '',
    isLoading: false,
    loadingText: 'æ­£åœ¨å¤„ç†...'
  },

  // é€‰æ‹©å›¾ç‰‡
  chooseImage() {
    wx.chooseImage({
      count: 1,
      sizeType: ['original'],
      sourceType: ['album', 'camera'],
      success: (res) => {
        this.enhanceImage(res.tempFilePaths[0]);
      }
    });
  },

  // å¢å¼ºå›¾ç‰‡
  enhanceImage(imagePath) {
    this.setData({
      isLoading: true,
      loadingText: 'æ­£åœ¨ä¸Šä¼ ...'
    });

    wx.uploadFile({
      url: 'https://gongjuxiang.work/api/v1/enhance',
      filePath: imagePath,
      name: 'file',
      formData: {
        'tile_size': '400',
        'quality_level': 'high'
      },
      success: (res) => {
        const data = JSON.parse(res.data);
        
        if (data.task_id) {
          this.setData({
            loadingText: 'æ­£åœ¨å¤„ç†...'
          });
          this.pollTaskStatus(data.task_id);
        } else {
          this.setData({
            isLoading: false,
            resultImage: data.enhanced_image
          });
        }
      },
      fail: (error) => {
        this.setData({ isLoading: false });
        this.handleError(error, 'ä¸Šä¼ å¤±è´¥');
      }
    });
  },

  // è½®è¯¢ä»»åŠ¡çŠ¶æ€
  pollTaskStatus(taskId) {
    const maxAttempts = 60;
    const interval = 5000;
    let attempts = 0;

    const poll = () => {
      attempts++;
      
      wx.request({
        url: `https://gongjuxiang.work/api/v1/status/${taskId}`,
        method: 'GET',
        success: (res) => {
          const data = res.data;
          
          if (data.status === 'completed') {
            this.downloadResult(taskId);
          } else if (data.status === 'failed') {
            this.setData({ isLoading: false });
            this.handleError(null, 'å¤„ç†å¤±è´¥');
          } else if (attempts < maxAttempts) {
            setTimeout(poll, interval);
          } else {
            this.setData({ isLoading: false });
            this.handleError(null, 'å¤„ç†è¶…æ—¶');
          }
        },
        fail: (error) => {
          this.setData({ isLoading: false });
          this.handleError(error, 'æŸ¥è¯¢çŠ¶æ€å¤±è´¥');
        }
      });
    };

    poll();
  },

  // ä¸‹è½½ç»“æœ
  downloadResult(taskId) {
    wx.request({
      url: `https://gongjuxiang.work/api/v1/download/${taskId}`,
      method: 'GET',
      responseType: 'arraybuffer',
      success: (res) => {
        const fs = wx.getFileSystemManager();
        const filePath = `${wx.env.USER_DATA_PATH}/enhanced_${taskId}.jpg`;
        
        fs.writeFile({
          filePath: filePath,
          data: res.data,
          success: () => {
            this.setData({
              isLoading: false,
              resultImage: filePath
            });
          },
          fail: (error) => {
            this.setData({ isLoading: false });
            this.handleError(error, 'ä¿å­˜å¤±è´¥');
          }
        });
      },
      fail: (error) => {
        this.setData({ isLoading: false });
        this.handleError(error, 'ä¸‹è½½å¤±è´¥');
      }
    });
  },

  // ä¿å­˜å›¾ç‰‡
  saveImage() {
    wx.saveImageToPhotosAlbum({
      filePath: this.data.resultImage,
      success: () => {
        wx.showToast({
          title: 'ä¿å­˜æˆåŠŸ',
          icon: 'success'
        });
      },
      fail: () => {
        wx.showToast({
          title: 'ä¿å­˜å¤±è´¥',
          icon: 'error'
        });
      }
    });
  },

  // é”™è¯¯å¤„ç†
  handleError(error, defaultMessage) {
    console.error('é”™è¯¯:', error);
    wx.showToast({
      title: defaultMessage,
      icon: 'error'
    });
  }
});
```

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. åŸŸåé…ç½®
- ç¡®ä¿åœ¨å°ç¨‹åºåå°æ­£ç¡®é…ç½® `https://gongjuxiang.work` ä¸ºåˆæ³•åŸŸå
- ä¸è¦ä½¿ç”¨IPåœ°å€ï¼Œå¿…é¡»ä½¿ç”¨HTTPSåŸŸå

### 2. æ–‡ä»¶å¤§å°é™åˆ¶
- å•å¼ å›¾ç‰‡å»ºè®®ä¸è¶…è¿‡10MB
- æ‰¹é‡å¤„ç†å»ºè®®ä¸è¶…è¿‡5å¼ å›¾ç‰‡

### 3. é”™è¯¯å¤„ç†
- å§‹ç»ˆå¤„ç†ç½‘ç»œè¯·æ±‚å¤±è´¥çš„æƒ…å†µ
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- è®°å½•é”™è¯¯æ—¥å¿—ä¾¿äºè°ƒè¯•

### 4. ç”¨æˆ·ä½“éªŒ
- æ˜¾ç¤ºå¤„ç†è¿›åº¦
- æä¾›å–æ¶ˆæ“ä½œ
- ä¼˜åŒ–åŠ è½½çŠ¶æ€æ˜¾ç¤º

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æ£€æŸ¥å°ç¨‹åºåå°åŸŸåé…ç½®
2. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
3. æµ‹è¯•APIæ¥å£è¿é€šæ€§
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**APIç½‘å…³åœ°å€**: `https://gongjuxiang.work/api/v1/`  
**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025å¹´9æœˆ21æ—¥  
**ç‰ˆæœ¬**: v1.0.0
