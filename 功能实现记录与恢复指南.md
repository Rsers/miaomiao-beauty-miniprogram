# 功能实现记录与恢复指南

> **文档说明**：本文档详细记录了所有已实现但在V1 MVP中被移除的功能，包括前端页面和后端功能。
> 方便后续版本快速恢复这些功能。

**创建日期**：2025年10月1日  
**当前V1分支**：`feature/mvp-iteration`  
**功能完整分支**：`feature/frontend-optimization`  
**后端功能分支**：`main`

---

## 📋 目录

- [Git版本信息](#git版本信息)
- [前端页面功能](#前端页面功能)
- [后端集成功能](#后端集成功能)
- [用户系统功能](#用户系统功能)
- [快速恢复指南](#快速恢复指南)

---

## 🔖 Git版本信息

### 关键分支

| 分支名称 | 说明 | 最新提交 |
|---------|------|---------|
| `main` | 后端功能实现分支（微信支付、OpenID等） | `7f49a09` |
| `feature/frontend-optimization` | 前端完整功能分支（所有页面） | `ad39b35` |
| `feature/mvp-iteration` | V1 MVP精简版本（当前分支） | 最新 |

### 功能删除记录

所有删除的文件已移动到：`.trash/pages/` 目录

---

## 🎨 前端页面功能

### 1. 首页 (home)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `e2bc7ed` - feat: 实现精美新首页设计
- **文件位置**: `.trash/pages/home/`

#### ✨ 功能特性
- ✅ 精美的首页设计
- ✅ 多个功能入口导航
- ✅ 装饰动画效果
  - 浮动爪印装饰
  - 猫咪头像动画
  - 背景渐变效果
  - 按钮悬停动画
- ✅ 用户信息显示（头像、昵称）
- ✅ 跳转到各功能页面

#### 📁 文件列表
```
.trash/pages/home/
├── home.json    # 页面配置
├── home.ts      # 页面逻辑
├── home.wxml    # 页面结构
└── home.wxss    # 页面样式
```

#### 🔄 恢复方法
```bash
# 1. 从trash恢复文件
cp -r .trash/pages/home/ miniprogram/pages/

# 2. 在app.json中添加页面
"pages": [
  "pages/splash/splash",
  "pages/home/home",      # 添加这行
  "pages/index/index",
  ...
]

# 3. 修改splash/splash.ts跳转目标
url: '/pages/home/home'  # 从index改回home
```

---

### 2. 美颜相机页 (camera)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `d0f9975` - feat: 实现完整美颜相机界面
- **后续优化**: `ad59172`, `6acc220` - 修复布局问题
- **文件位置**: `.trash/pages/camera/`

#### ✨ 功能特性
- ✅ 相机预览界面
- ✅ AI换脸功能
  - 双图片上传区域
  - 源图片和目标图片选择
  - AI换脸箭头动画
- ✅ 滤镜系统
  - 多种滤镜选择
  - 滤镜强度调节
  - 滤镜切换动画
- ✅ 猫咪主题滤镜
- ✅ VIP会员购买界面
- ✅ 社交功能
  - 邀请好友
  - 分享功能
- ✅ 精美动画效果
  - 滤镜切换动画
  - 按钮点击反馈
  - 进度条动画
  - 卡片悬停效果

#### 📁 文件列表
```
.trash/pages/camera/
├── camera.json   # 页面配置
├── camera.ts     # 页面逻辑
├── camera.wxml   # 页面结构（包含所有UI组件）
└── camera.wxss   # 页面样式（包含动画定义）
```

#### ⚠️ 注意事项
- 需要后端实现AI换脸API
- 需要实现滤镜处理算法
- 需要实现VIP会员系统（见后端功能部分）

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/camera/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/camera/camera",
  ...
]

# 3. 在首页添加入口
<view class="menu-item" bindtap="goToCamera">美颜相机</view>
```

---

### 3. 拼图协作页 (puzzle)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `bc7af54` - feat: 实现完整拼图协作界面
- **后续优化**: `3f6c2dd` - 修复为动态布局适配
- **文件位置**: `.trash/pages/puzzle/`

#### ✨ 功能特性
- ✅ 3x3拼图网格显示
- ✅ 实时拼图完成进度
- ✅ 团队协作功能
  - 多人协作拼图
  - 团队成员列表
  - 成员在线状态
- ✅ 社交分享功能
- ✅ 动画效果
  - 拼图块完成动画
  - 浮动爱心动画
  - 进度条动画
  - 庆祝完成动画
  - 成员状态指示器动画
- ✅ 交互功能
  - 拼图块点击交互
  - 成员头像点击
  - 一键完成演示功能

#### 📁 文件列表
```
.trash/pages/puzzle/
├── puzzle.json   # 页面配置
├── puzzle.ts     # 页面逻辑（包含拼图算法）
├── puzzle.wxml   # 页面结构
└── puzzle.wxss   # 页面样式（包含动画）
```

#### ⚠️ 注意事项
- 需要实现WebSocket实时通信
- 需要后端多人协作API
- 需要实现拼图图片切割算法

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/puzzle/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/puzzle/puzzle",
  ...
]
```

---

### 4. 推荐奖励页 (referral)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `130bb7c` - feat: 实现完整推荐奖励系统界面
- **后续优化**: `1cfe3c7` - 修复导航方法绑定
- **文件位置**: `.trash/pages/referral/`

#### ✨ 功能特性
- ✅ 邀请码系统
  - 专属邀请码生成
  - 一键复制功能
- ✅ 收益统计
  - 累计收益显示
  - 邀请人数统计
  - 获得奖励统计
- ✅ 多级奖励系统
  - 青铜、白银、黄金、铂金等级
  - 奖励进度条
  - 奖励内容展示
- ✅ VIP礼品卡
  - 礼品卡展示
  - 转赠功能
- ✅ 用户好评展示
- ✅ 动画效果
  - 浮动爱心装饰动画
  - 进度条动画
  - 按钮点击反馈
  - 卡片悬停效果

#### 📁 文件列表
```
.trash/pages/referral/
├── referral.json   # 页面配置
├── referral.ts     # 页面逻辑（包含邀请码生成）
├── referral.wxml   # 页面结构
└── referral.wxss   # 页面样式（包含动画）
```

#### ⚠️ 注意事项
- 需要后端邀请码生成API
- 需要实现奖励发放系统
- 需要实现礼品卡系统

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/referral/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/referral/referral",
  ...
]
```

---

### 5. 邀请好友页 (invite)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `a7226a5` - feat: 实现完整邀请好友系统界面
- **后续优化**: `5d02a95` - 修复导航栏显示变形问题
- **文件位置**: `.trash/pages/invite/`

#### ✨ 功能特性
- ✅ 成就追踪器
  - 邀请进度显示
  - 成就解锁状态
- ✅ 好友列表
  - 已邀请好友展示
  - 好友状态显示
- ✅ 奖励阶梯
  - 多级奖励展示
  - 进度条动画
- ✅ VIP转赠卡
- ✅ 社交分享功能

#### 📁 文件列表
```
.trash/pages/invite/
├── invite.json   # 页面配置
├── invite.ts     # 页面逻辑
├── invite.wxml   # 页面结构
└── invite.wxss   # 页面样式
```

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/invite/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/invite/invite",
  ...
]
```

---

### 6. 积分商城页 (mall)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `5d02a95` - feat: 实现完整积分商城系统界面
- **文件位置**: `.trash/pages/mall/`

#### ✨ 功能特性
- ✅ 积分头部区域
  - 积分余额显示
  - 签到功能
- ✅ 分类标签系统
  - 全部、实物、虚拟、会员等分类
  - 分类切换动画
- ✅ 商品网格展示
  - 商品卡片设计
  - 商品图片、名称、积分
  - 兑换按钮
- ✅ 热门标签
- ✅ 交互动画

#### 📁 文件列表
```
.trash/pages/mall/
├── mall.json   # 页面配置
├── mall.ts     # 页面逻辑（包含商品数据）
├── mall.wxml   # 页面结构
└── mall.wxss   # 页面样式
```

#### ⚠️ 注意事项
- 需要后端商品管理API
- 需要实现积分系统
- 需要实现订单系统

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/mall/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/mall/mall",
  ...
]
```

---

### 7. 个人资料页 (profile)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `ad39b35` - feat: 新增个人资料页面和用户流程图页面
- **文件位置**: `.trash/pages/profile/`

#### ✨ 功能特性
- ✅ 用户资料卡片
  - 头像、昵称、ID显示
  - 会员等级展示
- ✅ 会员卡展示
  - VIP等级显示
  - 会员权益说明
- ✅ 统计卡片
  - 积分、粉丝、获赞等数据
- ✅ 成就卡片
  - 成就徽章展示
  - 解锁进度
- ✅ 功能菜单
  - 我的订单、积分记录等
- ✅ 设置菜单
  - 账号设置、隐私设置等

#### 📁 文件列表
```
.trash/pages/profile/
├── profile.json   # 页面配置
├── profile.ts     # 页面逻辑
├── profile.wxml   # 页面结构
└── profile.wxss   # 页面样式
```

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/profile/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/profile/profile",
  ...
]
```

---

### 8. 用户流程图页 (userflow)

#### 📍 位置
- **分支**: `feature/frontend-optimization`
- **提交**: `ad39b35` - feat: 新增个人资料页面和用户流程图页面
- **文件位置**: `.trash/pages/userflow/`

#### ✨ 功能特性
- ✅ 用户流程可视化展示
- ✅ 交互式流程图
- ✅ 演示和测试用途

#### 📁 文件列表
```
.trash/pages/userflow/
├── userflow.json   # 页面配置
├── userflow.ts     # 页面逻辑
├── userflow.wxml   # 页面结构
└── userflow.wxss   # 页面样式
```

#### 🔄 恢复方法
```bash
# 1. 恢复页面文件
cp -r .trash/pages/userflow/ miniprogram/pages/

# 2. 在app.json中添加
"pages": [
  "pages/userflow/userflow",
  ...
]
```

---

### 9. 日志页面 (logs)

#### 📍 位置
- **文件位置**: `.trash/pages/logs/`

#### ✨ 功能特性
- ✅ 微信小程序示例页面
- ✅ 日志展示功能

#### 📁 文件列表
```
.trash/pages/logs/
├── logs.json   # 页面配置
├── logs.ts     # 页面逻辑
├── logs.wxml   # 页面结构
└── logs.wxss   # 页面样式
```

---

## 🔧 后端集成功能

### 1. 微信支付功能

#### 📍 位置
- **分支**: `main`
- **提交**: `7f49a09` - feat: 集成微信支付功能
- **相关提交**:
  - `5aa2409` - 添加支付界面UI设计
  - `4b02d7a` - 将付费套餐区域移动到页面顶部

#### ✨ 功能特性
- ✅ 微信支付集成
- ✅ 付费套餐系统
  - 基础包：¥9.9（10次增强）
  - 高级包：¥29.9（100次增强）
  - 无限包：¥99.9（无限次使用）
- ✅ 支付状态查询
- ✅ 订单管理

#### 📁 涉及文件

**前端文件**（在V1中已删除，可从git恢复）：
```
miniprogram/pages/index/index.wxml
miniprogram/pages/index/index.ts
miniprogram/pages/index/index.wxss
```

**关键代码位置**（在feature/frontend-optimization分支的index页面）：

```javascript
// miniprogram/pages/index/index.ts

// 选择套餐
selectPackage(e: any) {
  const { type, amount } = e.currentTarget.dataset;
  
  wx.showModal({
    title: '确认购买',
    content: `确定购买${type}套餐（¥${amount}）吗？`,
    success: (res) => {
      if (res.confirm) {
        this.createPayment(type, amount);
      }
    }
  });
},

// 创建支付
createPayment(type: string, amount: string) {
  const openid = wx.getStorageSync('openid');
  
  if (!openid) {
    wx.showToast({
      title: '请先获取OpenID',
      icon: 'error'
    });
    return;
  }

  wx.showLoading({
    title: '创建订单中...'
  });

  wx.request({
    url: 'https://www.gongjuxiang.work/api/wechat/pay/create',
    method: 'POST',
    header: {
      'Content-Type': 'application/json'
    },
    data: {
      openid: openid,
      total_fee: parseFloat(amount) * 100, // 转换为分
      body: `喵喵美颜-${type}套餐`,
      attach: `package_${type}_${Date.now()}`
    },
    success: (res: any) => {
      wx.hideLoading();
      
      if (res.data.success) {
        // 调用微信支付
        this.callWeChatPay(res.data.data.pay_params);
      } else {
        wx.showToast({
          title: res.data.error || '创建订单失败',
          icon: 'error'
        });
      }
    },
    fail: (err) => {
      wx.hideLoading();
      console.error('创建订单失败:', err);
      wx.showToast({
        title: '网络错误',
        icon: 'error'
      });
    }
  });
},

// 调用微信支付
callWeChatPay(payParams: any) {
  wx.requestPayment({
    timeStamp: payParams.timeStamp,
    nonceStr: payParams.nonceStr,
    package: payParams.package,
    signType: payParams.signType,
    paySign: payParams.paySign,
    success: (res) => {
      console.log('支付成功:', res);
      wx.showToast({
        title: '支付成功',
        icon: 'success'
      });
      
      // 更新用户套餐状态
      this.updateUserPackage();
    },
    fail: (res) => {
      console.log('支付失败:', res);
      
      if (res.errMsg.includes('cancel')) {
        wx.showToast({
          title: '支付已取消',
          icon: 'none'
        });
      } else {
        wx.showToast({
          title: '支付失败',
          icon: 'error'
        });
      }
    }
  });
}
```

#### 📄 API文档
详见项目根目录：`微信支付API调用指南.md`

#### 🔄 恢复方法

**方式一：从git恢复完整文件**
```bash
# 1. 查看main分支的index页面（包含支付功能）
git show main:miniprogram/pages/index/index.ts > /tmp/index_with_payment.ts

# 2. 对比和合并代码
# 可以手动复制支付相关的方法到当前index.ts
```

**方式二：从feature/frontend-optimization恢复**
```bash
# 该分支包含完整的UI和支付功能
git show feature/frontend-optimization:miniprogram/pages/index/index.wxml > /tmp/index_full.wxml
```

**方式三：手动添加**
1. 在 `index.wxml` 中添加付费套餐UI（从 `.trash` 或git历史中复制）
2. 在 `index.ts` 中添加支付相关方法（见上述代码）
3. 在 `index.wxss` 中添加套餐卡片样式
4. 确保后端API可用

#### ⚠️ 后端API要求
- `POST /api/wechat/pay/create` - 创建支付订单
- `GET /api/wechat/pay/query/{out_trade_no}` - 查询订单状态
- `GET /api/wechat/pay/orders/{openid}` - 获取用户订单列表

---

### 2. OpenID获取功能

#### 📍 位置
- **分支**: `main`
- **提交**: 
  - `1b85768` - fix: 修正获取OpenID的实现方式
  - `d2308a6` - feat: 添加调试按钮获取用户OpenID

#### ✨ 功能特性
- ✅ 微信登录获取code
- ✅ 后端换取OpenID
- ✅ 本地存储OpenID
- ✅ 调试按钮测试

#### 📁 关键代码

**前端代码**（已在V1中删除）：
```javascript
// miniprogram/pages/index/index.ts

// 获取用户OpenID
getUserOpenId() {
  wx.showLoading({
    title: '获取中...'
  });

  // 1. 调用wx.login获取code
  wx.login({
    success: (res) => {
      if (res.code) {
        console.log('登录code:', res.code);
        
        // 2. 将code发送到后端
        wx.request({
          url: 'https://www.gongjuxiang.work/api/wechat/auth/openid',
          method: 'POST',
          header: {
            'Content-Type': 'application/json'
          },
          data: {
            code: res.code
          },
          success: (authRes: any) => {
            wx.hideLoading();
            
            if (authRes.data.success) {
              const openid = authRes.data.data.openid;
              
              // 3. 保存到本地存储
              wx.setStorageSync('openid', openid);
              
              // 4. 显示结果
              wx.showModal({
                title: 'OpenID获取成功',
                content: `OpenID: ${openid}`,
                showCancel: false
              });
              
              console.log('OpenID:', openid);
            } else {
              wx.showToast({
                title: authRes.data.error || '获取失败',
                icon: 'error'
              });
            }
          },
          fail: (err) => {
            wx.hideLoading();
            console.error('请求失败:', err);
            wx.showToast({
              title: '网络错误',
              icon: 'error'
            });
          }
        });
      } else {
        wx.hideLoading();
        wx.showToast({
          title: '登录失败',
          icon: 'error'
        });
      }
    },
    fail: (err) => {
      wx.hideLoading();
      console.error('wx.login失败:', err);
      wx.showToast({
        title: '登录失败',
        icon: 'error'
      });
    }
  });
}
```

#### 🔄 恢复方法

**方式一：从git恢复**
```bash
# 查看main分支的实现
git show main:miniprogram/pages/index/index.ts | grep -A 50 "getUserOpenId"
```

**方式二：手动添加**
1. 在 `index.ts` 的 methods 中添加 `getUserOpenId` 方法
2. 在 `index.wxml` 中添加调试按钮（可选）
3. 确保后端API `/api/wechat/auth/openid` 可用

#### ⚠️ 后端API要求
- `POST /api/wechat/auth/openid` - 接收code换取openid

---

### 3. 用户头像和昵称功能

#### 📍 位置
- **分支**: `main`
- **提交**: 
  - `eb0cf7a` - feat: 在首页实现微信头像获取和昵称输入功能
  - `c4ad7fe` - docs: 更新README.md，详细记录用户信息获取功能
  - `3e637f4` - docs: 重要发现 - 无需登录即可获取用户头像和昵称

#### ✨ 功能特性
- ✅ 用户头像选择（微信官方组件）
- ✅ 昵称输入（微信推荐昵称）
- ✅ 本地存储用户信息
- ✅ 无需登录即可获取

#### 📁 关键代码

**WXML代码**（已在V1中删除）：
```xml
<!-- 用户头像区域 -->
<view class="user-avatar-section">
  <button class="avatar-wrapper" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
    <image class="avatar" src="{{avatarUrl}}" mode="aspectFill"></image>
  </button>
  <text class="avatar-tip">点击选择头像</text>
</view>

<!-- 昵称输入区域 -->
<view class="nickname-section">
  <view class="nickname-label">
    <text>昵称</text>
  </view>
  <input 
    type="nickname" 
    class="nickname-input" 
    placeholder="请输入昵称" 
    value="{{nickName}}" 
    bindinput="onNicknameInput" 
  />
</view>
```

**TypeScript代码**：
```typescript
// 默认头像
const defaultAvatarUrl = 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'

Component({
  data: {
    avatarUrl: defaultAvatarUrl,
    nickName: '',
  },

  lifetimes: {
    attached() {
      this.loadUserInfo();
    }
  },

  methods: {
    // 加载用户信息
    loadUserInfo() {
      try {
        const savedAvatar = wx.getStorageSync('userAvatar');
        const savedNickname = wx.getStorageSync('userNickname');
        
        if (savedAvatar) {
          this.setData({ avatarUrl: savedAvatar });
        }
        
        if (savedNickname) {
          this.setData({ nickName: savedNickname });
        }
      } catch (error) {
        console.error('加载用户信息失败:', error);
      }
    },

    // 选择头像
    onChooseAvatar(e: any) {
      const { avatarUrl } = e.detail;
      this.setData({ avatarUrl: avatarUrl });
      
      // 保存到本地
      wx.setStorageSync('userAvatar', avatarUrl);
      
      wx.showToast({
        title: '头像设置成功',
        icon: 'success'
      });
    },

    // 昵称输入
    onNicknameInput(e: any) {
      const nickName = e.detail.value;
      this.setData({ nickName: nickName });
      
      // 保存到本地
      wx.setStorageSync('userNickname', nickName);
    }
  }
})
```

#### 🔄 恢复方法

**从git恢复**：
```bash
# 查看main分支的完整实现
git show main:miniprogram/pages/index/index.wxml > /tmp/index_with_user.wxml
git show main:miniprogram/pages/index/index.ts > /tmp/index_with_user.ts
```

**手动添加**：
1. 在 `index.wxml` 开头添加用户头像和昵称区域
2. 在 `index.ts` 的 data 中添加 `avatarUrl` 和 `nickName`
3. 添加 `loadUserInfo()`, `onChooseAvatar()`, `onNicknameInput()` 方法
4. 在 `index.wxss` 中添加样式

---

### 4. 用户剩余次数和等级系统

#### 📍 位置
- **分支**: `feature/frontend-optimization` 的 index 页面
- **文件**: `miniprogram/pages/index/index.ts`

#### ✨ 功能特性
- ✅ 剩余次数统计
- ✅ 用户等级系统
  - free（免费用户）
  - basic（基础版）
  - premium（高级版）
  - unlimited（无限版）
- ✅ 本地存储用户状态

#### 📁 关键代码

```typescript
Component({
  data: {
    remainingCount: 3,        // 剩余次数
    userLevel: 'free',        // 用户等级
    userLevelText: '免费用户', // 用户等级文本
  },

  methods: {
    // 加载用户状态
    loadUserStatus() {
      try {
        const savedCount = wx.getStorageSync('remainingCount');
        const savedLevel = wx.getStorageSync('userLevel');
        
        if (savedCount !== undefined && savedCount !== '') {
          this.setData({ remainingCount: savedCount });
        }
        
        if (savedLevel) {
          this.setData({ 
            userLevel: savedLevel,
            userLevelText: this.getLevelText(savedLevel)
          });
        }
      } catch (error) {
        console.error('加载用户状态失败:', error);
      }
    },

    // 获取等级文本
    getLevelText(level: string): string {
      const levelMap: any = {
        'free': '免费用户',
        'basic': '基础版',
        'premium': '高级版',
        'unlimited': '无限版'
      };
      return levelMap[level] || '免费用户';
    },

    // 检查用户剩余次数
    checkUserRemainingCount(): boolean {
      if (this.data.userLevel === 'unlimited') {
        return true; // 无限版不检查次数
      }

      if (this.data.remainingCount <= 0) {
        wx.showModal({
          title: '次数不足',
          content: '您的免费次数已用完，请购买套餐继续使用',
          confirmText: '查看套餐',
          success: (res) => {
            if (res.confirm) {
              // 滚动到套餐区域
              wx.pageScrollTo({
                selector: '.payment-section',
                duration: 300
              });
            }
          }
        });
        return false;
      }

      return true;
    },

    // 更新用户套餐（支付成功后调用）
    updateUserPackage() {
      // 根据购买的套餐更新用户状态
      const packageType = wx.getStorageSync('purchasedPackage');
      
      let newCount = this.data.remainingCount;
      let newLevel = this.data.userLevel;

      switch(packageType) {
        case 'basic':
          newCount = 10;
          newLevel = 'basic';
          break;
        case 'premium':
          newCount = 100;
          newLevel = 'premium';
          break;
        case 'unlimited':
          newCount = -1; // -1表示无限
          newLevel = 'unlimited';
          break;
      }

      this.setData({
        remainingCount: newCount,
        userLevel: newLevel,
        userLevelText: this.getLevelText(newLevel)
      });

      // 保存到本地
      wx.setStorageSync('remainingCount', newCount);
      wx.setStorageSync('userLevel', newLevel);
    },

    // 使用一次（处理成功后调用）
    useOneTime() {
      if (this.data.userLevel === 'unlimited') {
        return; // 无限版不扣次数
      }

      const newCount = this.data.remainingCount - 1;
      this.setData({ remainingCount: newCount });
      wx.setStorageSync('remainingCount', newCount);
    }
  }
})
```

#### 🔄 恢复方法

**从git恢复**：
```bash
# 查看完整实现
git show feature/frontend-optimization:miniprogram/pages/index/index.ts | grep -A 100 "loadUserStatus"
```

**手动添加**：
1. 在 data 中添加 `remainingCount`, `userLevel`, `userLevelText`
2. 添加上述方法
3. 在 `enhanceImage` 方法开始时调用 `checkUserRemainingCount()`
4. 在处理成功后调用 `useOneTime()`

---

## 📚 用户系统功能

### 用户状态管理

#### 本地存储的数据
```javascript
// 用户信息
wx.setStorageSync('userAvatar', avatarUrl)      // 用户头像
wx.setStorageSync('userNickname', nickName)     // 用户昵称

// 用户状态
wx.setStorageSync('remainingCount', count)      // 剩余次数
wx.setStorageSync('userLevel', level)           // 用户等级
wx.setStorageSync('openid', openid)             // 微信OpenID

// 支付相关
wx.setStorageSync('purchasedPackage', type)     // 购买的套餐类型

// 隐私政策
wx.setStorageSync('privacyAgreed', true)        // 是否同意隐私政策
wx.setStorageSync('privacyAgreedTime', Date.now()) // 同意时间
```

---

## 🚀 快速恢复指南

### 场景1：恢复完整功能（所有页面 + 支付）

```bash
# 1. 切换到功能完整分支
git checkout feature/frontend-optimization

# 2. 创建新的开发分支
git checkout -b feature/full-features

# 3. 确认所有页面都存在
ls miniprogram/pages/

# 4. 测试功能
# 在微信开发者工具中测试所有页面
```

### 场景2：只恢复支付功能（保持V1简洁UI）

```bash
# 1. 停留在当前分支 feature/mvp-iteration

# 2. 查看main分支的支付代码
git show main:miniprogram/pages/index/index.ts > /tmp/index_payment.ts

# 3. 手动复制支付相关方法到当前index.ts
# - getUserOpenId()
# - selectPackage()
# - createPayment()
# - callWeChatPay()
# - updateUserPackage()

# 4. 添加支付UI到index.wxml
# 从git历史中复制付费套餐区域

# 5. 添加样式到index.wxss
# 从git历史中复制套餐卡片样式
```

### 场景3：逐步恢复页面

```bash
# 1. 从trash恢复需要的页面
cp -r .trash/pages/home/ miniprogram/pages/
cp -r .trash/pages/profile/ miniprogram/pages/

# 2. 在app.json中添加页面
# 编辑 miniprogram/app.json

# 3. 测试页面功能
```

### 场景4：恢复用户系统

```bash
# 1. 查看main分支的用户系统实现
git show main:miniprogram/pages/index/index.ts > /tmp/user_system.ts

# 2. 复制用户相关代码
# - data中的用户字段
# - loadUserInfo()
# - loadUserStatus()
# - onChooseAvatar()
# - onNicknameInput()
# - checkUserRemainingCount()
# - updateUserPackage()
# - useOneTime()

# 3. 添加UI
# 复制用户头像和昵称区域到index.wxml

# 4. 添加样式
# 复制用户区域样式到index.wxss
```

---

## 📦 完整功能恢复检查清单

### 前端页面
- [ ] 首页 (home)
- [ ] 美颜相机 (camera)
- [ ] 拼图协作 (puzzle)
- [ ] 推荐奖励 (referral)
- [ ] 邀请好友 (invite)
- [ ] 积分商城 (mall)
- [ ] 个人资料 (profile)
- [ ] 用户流程图 (userflow)

### 后端功能
- [ ] 微信支付
- [ ] OpenID获取
- [ ] 用户头像昵称
- [ ] 用户等级系统
- [ ] 剩余次数管理

### 测试项目
- [ ] 页面跳转正常
- [ ] 支付流程完整
- [ ] 用户信息保存
- [ ] 次数扣除正确
- [ ] 套餐购买生效

---

## 📞 技术支持

### 相关文档
- `README.md` - 项目总览
- `微信小程序调用指南.md` - API调用文档
- `微信支付API调用指南.md` - 支付集成文档
- `V1-MVP-实现总结.md` - V1版本说明

### Git分支说明
- `main` - 包含后端功能（支付、OpenID等）
- `feature/frontend-optimization` - 包含所有前端页面
- `feature/mvp-iteration` - V1精简版本（当前）

---

**最后更新时间**：2025年10月1日
**维护者**：喵喵美颜开发团队

