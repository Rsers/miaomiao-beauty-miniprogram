<!--index.wxml - Figma Make Design with Slider-->
<wxs module="utils">
  var round = function(num) {
    return Math.round(num);
  };
  module.exports = { round: round };
</wxs>

<view class="min-h-screen page-background">
  <view class="max-w-sm mx-auto content-background min-h-screen flex-col">
    
    <!-- Header -->
    <view class="header-section" style="padding-top: {{64 + safeAreaTop}}rpx;">
      <!-- 动态装饰元素层 -->
      <view class="header-decorations">
        <!-- 飘落的小猫 -->
        <view class="falling-cat cat-1">😸</view>
        <view class="falling-cat cat-2">🐱</view>
        <view class="falling-cat cat-3">😻</view>
        <view class="falling-cat cat-4">😺</view>
        <view class="falling-cat cat-5">🐈</view>
        <view class="falling-cat cat-6">😸</view>
        
        <!-- 飘落的爪印 -->
        <view class="falling-paw paw-1">🐾</view>
        <view class="falling-paw paw-2">🐾</view>
        <view class="falling-paw paw-3">🐾</view>
        <view class="falling-paw paw-4">🐾</view>
        
        <!-- 飘落的星星 -->
        <view class="falling-star star-1">✨</view>
        <view class="falling-star star-2">⭐</view>
        <view class="falling-star star-3">💫</view>
        <view class="falling-star star-4">✨</view>
        <view class="falling-star star-5">⭐</view>
      </view>
      
      <view class="relative z-10">
        <view class="mb-6">
          <view class="text-3xl text-white mb-3 tracking-wide drop-shadow-md">
            <text class="block text-2xl opacity-95 mb-1">✨ 超清魔法</text>
            <text class="block text-4xl gradient-text">喵喵美颜</text>
          </view>
          <view class="w-16 h-1 bg-white opacity-60 rounded-full mx-auto mb-4"></view>
          <view class="text-lg text-white opacity-95 leading-relaxed tracking-wide">
            <text class="block">🌸 自然变美 · 权威出片</text>
            <text class="block">🎨 告别违和感 · 美得真实</text>
          </view>
        </view>
      </view>
    </view>

    <view class="px-6 space-y-6 flex-1">
      
      <!-- 额度显示卡片 -->
      <view class="quota-card">
        <view class="quota-main">
          <view class="quota-icon">💎</view>
          <view class="quota-info">
            <text class="quota-title">今日剩余额度</text>
            <text class="quota-value">{{quotaRemaining}}/{{quotaTotal}} 次</text>
          </view>
        </view>
        
        <!-- 额外奖励提示（优先级最高） -->
        <view class="quota-hint" wx:if="{{quotaBonus > 0}}">
          <text class="quota-bonus-text">🎁 已获得 {{quotaBonus}} 次额外额度</text>
        </view>
        
        <!-- 低额度警告（次高优先级，且无额外奖励时显示） -->
        <view class="quota-hint" wx:elif="{{quotaRemaining <= 5}}">
          <text class="quota-warning-text">⚠️ 额度即将用完，分享可获 10 次额外额度</text>
        </view>
        
        <!-- 分享鼓励与清零机制提示（额度正常时显示） -->
        <view class="quota-hint" wx:else>
          <text class="quota-share-benefit">✨ 每日0点额度焕新！分享给好友：你获10次，她也获10次！</text>
        </view>
      </view>
      
      <!-- 快速测试区域 -->
      <view class="mt-4">
        <view class="section-title-enhanced">
          <view class="title-icon">✨</view>
          <text class="title-text">开始你的变美之旅</text>
          <view class="title-icon">✨</view>
        </view>
        
        <!-- 快速测试折叠区域 -->
        <view class="quick-test-section">
          <view class="quick-test-header" bindtap="toggleQuickTest">
            <view class="quick-test-title">
              <text class="quick-test-icon">⚡</text>
              <text class="quick-test-text">快速体验</text>
            </view>
            <view class="quick-test-arrow {{quickTestExpanded ? 'expanded' : ''}}">
              <text>▼</text>
            </view>
          </view>
          
          <view class="quick-test-hint">
            <text>选择测试图片，快速体验美颜效果</text>
          </view>
          
          <view class="quick-test-content {{quickTestExpanded ? 'expanded' : ''}}">
            <scroll-view class="quick-test-grid" scroll-x="true">
              <view class="quick-test-images">
                <view 
                  wx:for="{{quickTestImages}}" 
                  wx:key="id" 
                  class="quick-test-item"
                  bindtap="selectQuickTestImage"
                  data-index="{{index}}"
                >
                  <image src="{{item.path}}" mode="aspectFill" class="quick-test-image"></image>
                  <view class="quick-test-name">{{item.name}}</view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>

        <!-- 分隔线 -->
        <view class="quick-test-divider">
          <view class="divider-line"></view>
          <text class="divider-text">或</text>
          <view class="divider-line"></view>
        </view>
        
        <!-- 上传区域 -->
        <view wx:if="{{!selectedFile}}" class="upload-area upload-area-animated" bindtap="chooseImage">
          <view class="upload-icon-wrapper">
            <view class="upload-icon">📷</view>
          </view>
          <text class="upload-text-main">点击选择照片</text>
          <text class="upload-text-sub">支持 JPG、PNG、AVIF 格式</text>
          <!-- 装饰元素 -->
          <view class="upload-decorations">
            <view class="deco-sparkle deco-1">✨</view>
            <view class="deco-sparkle deco-2">✨</view>
            <view class="deco-sparkle deco-3">⭐</view>
            <view class="deco-sparkle deco-4">💫</view>
          </view>
        </view>
        
        <view wx:else class="space-y-4">
          <view class="relative">
            <image src="{{selectedFile.preview}}" mode="aspectFit" class="w-full max-h-96 rounded-2xl"></image>
            
            <view wx:if="{{isProcessing}}" class="processing-overlay">
              <view class="text-center text-white p-6">
                <view class="text-4xl mb-3 animate-pulse">✨😸✨</view>
                <text class="text-lg mb-4">正在为您变美中...</text>
                
                <view class="progress-circle-wrapper">
                  <view class="progress-svg">
                    <view class="progress-bg-circle"></view>
                    <view class="progress-fill-circle" style="stroke-dashoffset: {{251.2 * (1 - progress / 100)}};"></view>
                  </view>
                  <view class="progress-text-overlay">
                    <text class="text-xl">{{utils.round(progress)}}%</text>
                  </view>
                </view>
                
                <text class="text-sm opacity-80">喵喵正在施展魔法...</text>
              </view>
            </view>
          </view>

          <view class="flex gap-3 button-group-spacing">
            <button bindtap="chooseImage" disabled="{{isProcessing}}" class="btn-reselect">重新选择</button>
            <button bindtap="handleStartProcessing" disabled="{{isProcessing}}" class="btn-start">
              {{isProcessing ? '处理中...' : '立即变美'}}
            </button>
          </view>
        </view>
      </view>

      <!-- Result Section -->
      <view wx:if="{{showResult && selectedFile}}" class="result-section">
        <view class="result-header">
          <view class="result-title-section">
            <text class="result-title-icon">✨</text>
            <text class="result-title-text">惊艳呈现</text>
          </view>
          <button bindtap="handleTryAgain" class="btn-retry">🔄 再试一次</button>
        </view>
        
        <view class="result-hint">
          <text class="result-hint-text">查看美化前后的对比效果</text>
        </view>
        
        <!-- 放大查看引导 -->
        <view class="zoom-guide">
          <view class="zoom-guide-icon">🔍</view>
          <view class="zoom-guide-text">
            <text class="zoom-guide-main">点击图片放大查看细节</text>
            <text class="zoom-guide-sub">发丝清晰可见 · 眼睛更清澈 · 肤色更白皙 · 背景更清晰</text>
          </view>
        </view>

        <!-- 滑动对比功能暂时隐藏 -->
        <!-- <view class="flex justify-center mb-6">
          <view class="toggle-container">
            <button bindtap="setCompareMode" data-mode="side-by-side" 
                    class="toggle-btn {{compareMode === 'side-by-side' ? 'active' : ''}}">
              对比查看
            </button>
            <button bindtap="setCompareMode" data-mode="slider"
                    class="toggle-btn {{compareMode === 'slider' ? 'active' : ''}}">
              滑动对比
            </button>
          </view>
        </view> -->

        <view class="grid grid-cols-2 gap-4 mb-6">
          <view wx:for="{{comparisonImages}}" wx:key="index">
            <view class="comparison-label-row">
              <text class="text-sm text-gray-700">{{item.label}}</text>
              <text class="{{item.enhanced ? 'desc-tag-enhanced' : 'desc-tag-normal'}}">{{item.desc}}</text>
            </view>
            <view class="image-container" bindtap="openFullscreen" data-src="{{item.src}}" data-title="{{item.label}}">
              <image src="{{item.src}}" mode="aspectFill" 
                     class="w-full h-64 rounded-xl border-2 border-gray-200"
                     style="{{item.enhanced ? 'filter: contrast(1.1) brightness(1.05) saturate(1.1);' : ''}}"></image>
              <view class="image-overlay">
                <view class="zoom-icon">
                  <text class="text-white text-sm">🔍</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 滑动对比功能暂时隐藏 -->
        <!-- <view wx:else class="mb-6">
          <view class="slider-container" bindtouchmove="handleSliderMove">
            <image src="{{comparisonImages[0].src}}" 
                   mode="aspectFit" 
                   class="slider-image-base"></image>
            <view class="slider-top-wrapper" style="width: {{sliderPosition}}%;">
              <image wx:if="{{comparisonImages[1] && comparisonImages[1].src}}" 
                     src="{{comparisonImages[1].src}}" 
                     mode="aspectFit" 
                     class="slider-image-enhanced"
                     style="width: {{sliderContainerWidth > 0 ? sliderContainerWidth : 375}}px;"></image>
            </view>
            <view class="slider-divider" style="left: {{sliderPosition}}%;">
              <view class="slider-handle">
                <text class="slider-handle-icon">↔</text>
              </view>
            </view>
            <view class="slider-label slider-label-left">原图</view>
            <view class="slider-label slider-label-right">修复后</view>
          </view>
        </view> -->

        <view class="space-y-4">
          <button bindtap="handleSaveImage" class="btn-download-enhanced">
            <view class="btn-icon-wrapper">
              <text class="btn-icon-large">💾</text>
            </view>
            <view class="btn-content">
              <text class="btn-text-main">保存到相册</text>
            </view>
          </button>
          
          <view class="flex gap-4">
            <button bindtap="handleTryAgain" class="btn-secondary-enhanced">
              <text class="btn-emoji">🔄</text>
              <view class="btn-text-wrapper">
                <text class="btn-text-primary">再来一次</text>
                <text class="btn-text-hint">继续变美</text>
              </view>
            </button>
            <button open-type="share" class="btn-share-enhanced">
              <text class="btn-emoji">✨</text>
              <view class="btn-text-wrapper">
                <text class="btn-text-primary">分享好友</text>
                <text class="btn-text-hint">一起变美</text>
              </view>
            </button>
          </view>
          
          <view class="share-hint-enhanced">
            <text class="share-hint-icon">💕</text>
            <text class="share-hint-text">分享给闺蜜，让更多人发现这个宝藏小程序</text>
          </view>
        </view>

        <view class="stats-card-enhanced">
          <view class="stats-header-enhanced">
            <text class="stats-emoji">✨</text>
            <text class="stats-title">惊艳蜕变数据</text>
            <text class="stats-emoji">✨</text>
          </view>
          
          <!-- 分辨率信息 - 增强版 -->
          <view class="resolution-info-enhanced">
            <view class="resolution-row-compact">
              <text class="resolution-label-small">📷 原图</text>
              <text class="resolution-value-small">{{originalResolution}}</text>
            </view>
            <view class="resolution-arrow-enhanced">
              <text class="arrow-text-enhanced">⚡ 魔法变身 ⚡</text>
            </view>
            <view class="resolution-row-highlight">
              <text class="resolution-label-big">✨ 美化后</text>
              <text class="resolution-value-big">{{enhancedResolution}}</text>
            </view>
            <view class="resolution-multiple-enhanced" wx:if="{{resolutionMultiple > 1}}">
              <text class="multiple-badge-enhanced">🎯 画质狂飙 {{resolutionMultiple}}x 🚀</text>
            </view>
          </view>
          
          <!-- 效果数据 - 增强版 -->
          <view class="stats-grid-enhanced">
            <view class="stat-item-enhanced stat-item-primary">
              <text class="stat-label-enhanced">✨ 清晰度</text>
              <text class="stat-value-enhanced stat-value-large">+{{clarityImprovement}}%</text>
              <text class="stat-desc">超清呈现</text>
            </view>
            <view class="stat-item-enhanced stat-item-danger">
              <text class="stat-label-enhanced">🔇 噪点</text>
              <text class="stat-value-enhanced stat-value-large">-{{noiseReduction}}%</text>
              <text class="stat-desc">净化画面</text>
            </view>
            <view class="stat-item-enhanced stat-item-success">
              <text class="stat-label-enhanced">🎨 色彩</text>
              <text class="stat-value-enhanced stat-value-large">+{{colorRestoration}}%</text>
              <text class="stat-desc">还原真实</text>
            </view>
            <view class="stat-item-enhanced stat-item-info">
              <text class="stat-label-enhanced">⚡ 耗时</text>
              <text class="stat-value-enhanced stat-value-time">{{processTime}}秒</text>
              <text class="stat-desc">极速处理</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Features -->
    <view class="px-6 mb-6">
      <view class="features-card">
        <text class="text-center mb-4 text-gray-700 text-sm">核心特点</text>
        <view class="grid grid-cols-3 gap-3">
          <view wx:for="{{features}}" wx:key="index" class="feature-item">
            <view class="feature-icon">{{item.icon}}</view>
            <text class="text-xs text-gray-800 mb-1">{{item.title}}</text>
            <text class="text-xs text-gray-600">{{item.desc}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Privacy -->
    <view class="px-6 mb-6">
      <view class="privacy-card">
        <view class="flex items-center gap-3">
          <view class="privacy-icon">🔒</view>
          <view class="text-white flex-1">
            <text class="privacy-title">隐私承诺</text>
            <text class="privacy-desc">本地处理，不保存照片</text>
          </view>
          <view class="privacy-check">
            <text class="text-white text-xs">✓</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 用户反馈入口 -->
    <view class="feedback-section">
      <button bindtap="openFeedback" class="feedback-btn">
        <text class="feedback-icon">💬</text>
        <text class="feedback-text">意见反馈</text>
      </button>
    </view>

    <!-- Footer -->
    <view class="p-6 text-center text-gray-500">
      <view class="text-sm mb-2">
        <text bindtap="openTerms" class="text-gray-500">服务条款</text>
        <text> | </text>
        <text bindtap="openPrivacy" class="text-gray-500">隐私政策</text>
      </view>
      <text class="text-xs">使用本服务即表示您同意相关条款</text>
    </view>
    
  </view>
</view>
