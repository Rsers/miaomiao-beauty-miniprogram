<!--index.wxml - Figma Make Design with Slider-->
<wxs module="utils">
  var round = function(num) {
    return Math.round(num);
  };
  module.exports = { round: round };
</wxs>

<view class="min-h-screen bg-gray-50">
  <view class="max-w-sm mx-auto bg-white min-h-screen flex-col">
    
    <!-- Header -->
    <view class="header-section" style="padding-top: {{64 + safeAreaTop}}rpx;">
      <view class="absolute inset-0">
        <view class="absolute top-3 right-3 text-3xl opacity-30 rotate-12">🐱</view>
        <view class="absolute top-8 right-12 text-lg opacity-25">😸</view>
        <view class="absolute top-1-3 right-6 text-sm opacity-20 rotate-minus-12">🐾</view>
        <view class="absolute bottom-6 left-4 text-2xl opacity-30 rotate-minus-6">😻</view>
        <view class="absolute bottom-12 left-8 text-xs opacity-25">🐾</view>
        <view class="absolute top-1-2 left-4 text-sm opacity-20 rotate-6">😴</view>
        <view class="absolute top-6 right-20 text-xs opacity-30">✨</view>
        <view class="absolute bottom-16 left-16 text-xs opacity-25">✨</view>
      </view>
      
      <view class="relative z-10">
        <view class="mb-6">
          <view class="text-3xl text-white mb-3 tracking-wide drop-shadow-md">
            <text class="block text-2xl opacity-95 mb-1">✨ 超清魔法</text>
            <text class="block text-4xl gradient-text">喵喵美颜</text>
          </view>
          <view class="w-16 h-1 bg-white opacity-60 rounded-full mx-auto mb-4"></view>
          <view class="text-lg text-white opacity-95 leading-relaxed tracking-wide">
            <text class="block">🌸 自然变美 · 权威出片</text>
            <text class="block">🎨 告别违和感 · 美得真实</text>
          </view>
        </view>
      </view>
    </view>

    <view class="px-6 space-y-6 flex-1">
      
      <!-- 快速测试区域 -->
      <view class="mt-4">
        <view class="section-title-enhanced">
          <view class="title-icon">✨</view>
          <text class="title-text">开始你的变美之旅</text>
          <view class="title-icon">✨</view>
        </view>
        
        <!-- 快速测试折叠区域 -->
        <view class="quick-test-section">
          <view class="quick-test-header" bindtap="toggleQuickTest">
            <view class="quick-test-title">
              <text class="quick-test-icon">⚡</text>
              <text class="quick-test-text">快速体验</text>
            </view>
            <view class="quick-test-arrow {{quickTestExpanded ? 'expanded' : ''}}">
              <text>▼</text>
            </view>
          </view>
          
          <view class="quick-test-hint">
            <text>选择测试图片，快速体验修复效果</text>
          </view>
          
          <view class="quick-test-content {{quickTestExpanded ? 'expanded' : ''}}">
            <scroll-view class="quick-test-grid" scroll-x="true">
              <view class="quick-test-images">
                <view 
                  wx:for="{{quickTestImages}}" 
                  wx:key="id" 
                  class="quick-test-item"
                  bindtap="selectQuickTestImage"
                  data-index="{{index}}"
                >
                  <image src="{{item.path}}" mode="aspectFill" class="quick-test-image"></image>
                  <view class="quick-test-name">{{item.name}}</view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>

        <!-- 分隔线 -->
        <view class="quick-test-divider">
          <view class="divider-line"></view>
          <text class="divider-text">或</text>
          <view class="divider-line"></view>
        </view>
        
        <!-- 上传区域 -->
        <view wx:if="{{!selectedFile}}" class="upload-area" bindtap="chooseImage">
          <view class="text-6xl mb-4">📷</view>
          <text class="text-lg text-gray-700 mb-2">点击选择图片</text>
          <text class="text-sm text-gray-600">支持 JPG、PNG、AVIF 格式</text>
        </view>
        
        <view wx:else class="space-y-4">
          <view class="relative">
            <image src="{{selectedFile.preview}}" mode="aspectFit" class="w-full max-h-96 rounded-2xl"></image>
            
            <view wx:if="{{isProcessing}}" class="processing-overlay">
              <view class="text-center text-white p-6">
                <view class="text-4xl mb-3 animate-pulse">✨😸✨</view>
                <text class="text-lg mb-4">正在修复您的图片...</text>
                
                <view class="progress-circle-wrapper">
                  <view class="progress-svg">
                    <view class="progress-bg-circle"></view>
                    <view class="progress-fill-circle" style="stroke-dashoffset: {{251.2 * (1 - progress / 100)}};"></view>
                  </view>
                  <view class="progress-text-overlay">
                    <text class="text-xl">{{utils.round(progress)}}%</text>
                  </view>
                </view>
                
                <text class="text-sm opacity-80">喵喵正在努力修复中...</text>
              </view>
            </view>
          </view>

          <view class="flex gap-3">
            <button bindtap="chooseImage" disabled="{{isProcessing}}" class="btn-reselect">重新选择</button>
            <button bindtap="handleStartProcessing" disabled="{{isProcessing}}" class="btn-start">
              {{isProcessing ? '修复中...' : '开始修复'}}
            </button>
          </view>
        </view>
      </view>

      <!-- Result Section -->
      <view wx:if="{{showResult && selectedFile}}" class="result-section">
        <view class="result-header">
          <view class="result-title-section">
            <text class="result-title-icon">✨</text>
            <text class="result-title-text">惊艳呈现</text>
          </view>
          <button bindtap="handleTryAgain" class="btn-retry">🔄 再试一次</button>
        </view>
        
        <view class="result-hint">
          <text class="result-hint-text">查看修复前后的对比效果</text>
        </view>
        
        <!-- 放大查看引导 -->
        <view class="zoom-guide">
          <view class="zoom-guide-icon">🔍</view>
          <view class="zoom-guide-text">
            <text class="zoom-guide-main">点击图片放大查看细节</text>
            <text class="zoom-guide-sub">发丝清晰可见 · 眼睛更清澈 · 肤色更白皙 · 背景更清晰</text>
          </view>
        </view>

        <!-- 滑动对比功能暂时隐藏 -->
        <!-- <view class="flex justify-center mb-6">
          <view class="toggle-container">
            <button bindtap="setCompareMode" data-mode="side-by-side" 
                    class="toggle-btn {{compareMode === 'side-by-side' ? 'active' : ''}}">
              对比查看
            </button>
            <button bindtap="setCompareMode" data-mode="slider"
                    class="toggle-btn {{compareMode === 'slider' ? 'active' : ''}}">
              滑动对比
            </button>
          </view>
        </view> -->

        <view class="grid grid-cols-2 gap-4 mb-6">
          <view wx:for="{{comparisonImages}}" wx:key="index">
            <view class="flex items-center justify-between mb-2">
              <text class="text-sm text-gray-700">{{item.label}}</text>
              <text class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{{item.desc}}</text>
            </view>
            <view class="image-container" bindtap="openFullscreen" data-src="{{item.src}}" data-title="{{item.label}}">
              <image src="{{item.src}}" mode="aspectFill" 
                     class="w-full h-64 rounded-xl border-2 border-gray-200"
                     style="{{item.enhanced ? 'filter: contrast(1.1) brightness(1.05) saturate(1.1);' : ''}}"></image>
              <view class="image-overlay">
                <view class="zoom-icon">
                  <text class="text-white text-sm">🔍</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 滑动对比功能暂时隐藏 -->
        <!-- <view wx:else class="mb-6">
          <view class="slider-container" bindtouchmove="handleSliderMove">
            <image src="{{comparisonImages[0].src}}" 
                   mode="aspectFit" 
                   class="slider-image-base"></image>
            <view class="slider-top-wrapper" style="width: {{sliderPosition}}%;">
              <image wx:if="{{comparisonImages[1] && comparisonImages[1].src}}" 
                     src="{{comparisonImages[1].src}}" 
                     mode="aspectFit" 
                     class="slider-image-enhanced"
                     style="width: {{sliderContainerWidth > 0 ? sliderContainerWidth : 375}}px;"></image>
            </view>
            <view class="slider-divider" style="left: {{sliderPosition}}%;">
              <view class="slider-handle">
                <text class="slider-handle-icon">↔</text>
              </view>
            </view>
            <view class="slider-label slider-label-left">原图</view>
            <view class="slider-label slider-label-right">修复后</view>
          </view>
        </view> -->

        <view class="space-y-4">
          <button bindtap="handleSaveImage" class="btn-download">
            <text class="text-xl">💾</text>
            <text>保存图片</text>
          </button>
          
          <view class="flex gap-4">
            <button bindtap="handleTryAgain" class="btn-secondary">🔄 重新修复</button>
            <button open-type="share" class="btn-share">📤 分享小程序</button>
          </view>
          
          <view class="share-hint">
            <text class="text-xs text-gray-600">💡 分享给闺蜜好友，一起变美变自信</text>
          </view>
        </view>

        <view class="stats-card">
          <view class="stats-header">
            <text>📊</text>
            <text>修复效果分析</text>
          </view>
          
          <!-- 分辨率信息 -->
          <view class="resolution-info">
            <view class="resolution-row">
              <text class="resolution-label">📷 原始分辨率：</text>
              <text class="resolution-value">{{originalResolution}}</text>
            </view>
            <view class="resolution-arrow">
              <text class="arrow-icon">⬇️</text>
              <text class="arrow-text">智能修复</text>
              <text class="arrow-icon">⬇️</text>
            </view>
            <view class="resolution-row">
              <text class="resolution-label">✨ 修复后分辨率：</text>
              <text class="resolution-value highlight">{{enhancedResolution}}</text>
            </view>
            <view class="resolution-multiple" wx:if="{{resolutionMultiple > 1}}">
              <text class="multiple-badge">🎯 提升 {{resolutionMultiple}}x</text>
            </view>
          </view>
          
          <!-- 效果数据 -->
          <view class="stats-grid">
            <view class="stat-item">
              <text class="text-gray-600">✨ 清晰度提升</text>
              <text class="text-green-600">+{{clarityImprovement}}%</text>
            </view>
            <view class="stat-item">
              <text class="text-gray-600">🔇 噪点减少</text>
              <text class="text-green-600">-{{noiseReduction}}%</text>
            </view>
            <view class="stat-item">
              <text class="text-gray-600">🎨 色彩还原</text>
              <text class="text-green-600">+{{colorRestoration}}%</text>
            </view>
            <view class="stat-item">
              <text class="text-gray-600">⚡ 处理时间</text>
              <text class="text-blue-600">{{processTime}}秒</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Features -->
    <view class="px-6 mb-6 mt-16">
      <view class="features-card">
        <text class="text-center mb-4 text-gray-700 text-sm">核心特点</text>
        <view class="grid grid-cols-3 gap-3">
          <view wx:for="{{features}}" wx:key="index" class="feature-item">
            <view class="feature-icon">{{item.icon}}</view>
            <text class="text-xs text-gray-800 mb-1">{{item.title}}</text>
            <text class="text-xs text-gray-600">{{item.desc}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Privacy -->
    <view class="px-6 mb-6">
      <view class="privacy-card">
        <view class="flex items-center gap-3">
          <view class="privacy-icon">🔒</view>
          <view class="text-white flex-1">
            <text class="privacy-title">隐私承诺</text>
            <text class="privacy-desc">本地处理，不保存照片</text>
          </view>
          <view class="privacy-check">
            <text class="text-white text-xs">✓</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Footer -->
    <view class="p-6 text-center text-gray-500">
      <view class="text-sm mb-2">
        <text bindtap="openTerms" class="text-gray-500">服务条款</text>
        <text> | </text>
        <text bindtap="openPrivacy" class="text-gray-500">隐私政策</text>
      </view>
      <text class="text-xs">使用本服务即表示您同意相关条款</text>
    </view>
    
  </view>
</view>
